{# customer/templates/pending_reviews.html #}
{% extends "partials/customer/customer_navigation.html" %}

{% block customer_content %}
<div class="mb-6">
  <h1 class="text-2xl font-bold tracking-tight">Pending reviews</h1>
  <p class="text-sm text-gray-500">Rate the products you’ve received. Your feedback helps everyone.</p>
</div>

{% if pending_items %}
<ul id="pending-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5">
  {% for it in pending_items %}
    {% with p=it.product_variation.product pv=it.product_variation %}
    <li id="pr-card-{{ p.id }}" class="rounded-2xl border border-gray-200 bg-white overflow-hidden">
      <div class="relative aspect-[4/3] bg-gray-50">
        {% if pv.images.first %}
          <img src="{{ pv.images.first.image.url }}" alt="{{ p.name }}" class="h-full w-full object-cover">
        {% elif p.primary_image and p.primary_image.image %}
          <img src="{{ p.primary_image.image.url }}" alt="{{ p.name }}" class="h-full w-full object-cover">
        {% else %}
          <div class="h-full w-full grid place-items-center text-xs text-gray-400">{{ p.name|truncatechars:12 }}</div>
        {% endif %}
      </div>

      <div class="p-4">
        <div class="min-w-0">
          <div class="truncate font-medium">{{ p.name }}</div>
          <div class="text-xs text-gray-500">
            {% for v in pv.variations.all %}{{ v.value }}{% if not forloop.last %}, {% endif %}{% endfor %}
          </div>
        </div>

        <div class="mt-3 flex items-center justify-between">
          <div class="text-sm text-gray-600">Qty: {{ it.quantity }}</div>
          <button
            class="inline-flex items-center gap-2 rounded-lg bg-gray-900 text-white px-3 py-1.5 text-xs font-semibold hover:bg-black"
            data-review-btn
            data-product-id="{{ p.id }}"
            data-product-name="{{ p.name|escape }}"
          >
            Review product
          </button>
        </div>
      </div>
    </li>
    {% endwith %}
  {% endfor %}
</ul>
{% else %}
  <div class="rounded-2xl border border-gray-200 bg-white p-10 text-center">
    <div class="mx-auto mb-3 h-12 w-12 rounded-full bg-gray-100 grid place-items-center">
      <svg class="h-6 w-6 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24"><path d="M3 3h18v2H3V3zm0 4h18v14l-6-4-6 4-6-4V7z"/></svg>
    </div>
    <p class="text-sm text-gray-600">Nothing to review right now. We’ll bring items here after they’re delivered.</p>
  </div>
{% endif %}

{# ===== Modal (fixed root with very high z; overlay is lower than panel) ===== #}
<div id="reviewModal" class="fixed inset-0 hidden z-[10000]">
  <!-- overlay (z-0) -->
  <div class="absolute inset-0 bg-black/50 z-0" data-modal-dismiss></div>

  <!-- panel wrapper (z-10) -->
  <div class="relative z-10 mx-auto mt-20 w-full max-w-lg px-4">
    <div class="rounded-2xl bg-white shadow-2xl overflow-hidden">
      <div class="px-5 py-4 border-b border-gray-100 flex items-center justify-between">
        <div>
          <div class="text-xs uppercase tracking-wide text-gray-500">Write a review</div>
          <div id="modalProductName" class="text-sm font-semibold truncate"></div>
        </div>
        <button class="rounded-lg p-2 hover:bg-gray-50" data-modal-dismiss aria-label="Close">
          <svg class="h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18 18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>

      <form id="reviewForm" class="p-5">
        {% csrf_token %}
        <input type="hidden" name="product_id" id="productIdField">

        <div class="mb-4">
          <label class="text-sm font-medium">Rating</label>
          <div class="mt-2 flex items-center gap-1" id="starInputs">
            {% for n in "12345" %}
              <input type="radio" name="rating" id="rate-{{ forloop.counter }}" value="{{ forloop.counter }}" class="hidden">
              <label for="rate-{{ forloop.counter }}" class="cursor-pointer select-none">
                <svg class="h-7 w-7 star" data-star value="{{ forloop.counter }}" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 17.27 18.18 21l-1.64-7.03L22 9.24l-7.19-.62L12 2 9.19 8.62 2 9.24l5.46 4.73L5.82 21z"/>
                </svg>
              </label>
            {% endfor %}
          </div>
          <p id="ratingHelp" class="mt-1 text-xs text-gray-500">Tap a star to rate (1–5).</p>
        </div>

        <div class="mb-2">
          <label class="text-sm font-medium" for="comment">Your thoughts (optional)</label>
          <textarea id="comment" name="comment" rows="4" class="mt-2 w-full rounded-xl border border-gray-300 px-3 py-2 text-sm focus:ring-2 focus:ring-gray-900/20 focus:border-gray-400" placeholder="Tell others about fit, quality, delivery…"></textarea>
        </div>

        <div class="mt-4 flex items-center justify-end gap-2">
          <button type="button" class="rounded-lg px-3 py-2 text-sm hover:bg-gray-50" data-modal-dismiss>Cancel</button>
          <button type="submit" class="rounded-lg bg-gray-900 text-white px-4 py-2 text-sm font-semibold hover:bg-black" id="submitBtn">Submit review</button>
        </div>

        <div id="formMsg" class="mt-3 text-sm"></div>
      </form>
    </div>
  </div>
</div>

<style>
  /* star defaults + active color */
  .star { color: #d1d5db; }       /* gray-300 */
  .star.active { color: #f59e0b; } /* amber-500 */
</style>

<script>
(function(){
  const modal = document.getElementById('reviewModal');
  const productNameEl = document.getElementById('modalProductName');
  const productIdField = document.getElementById('productIdField');
  const form = document.getElementById('reviewForm');
  const msg = document.getElementById('formMsg');
  const submitBtn = document.getElementById('submitBtn');
  const stars = Array.from(document.querySelectorAll('[data-star]'));
  const endpoint = "{% url 'customer:submit_review' %}";

  function openModal(productId, productName) {
    productIdField.value = productId;
    productNameEl.textContent = productName || 'Product';
    msg.textContent = '';
    msg.className = 'mt-3 text-sm';
    // reset stars & rating
    stars.forEach(s => s.classList.remove('active'));
    form.reset();
    modal.classList.remove('hidden');
    document.body.classList.add('overflow-hidden');
  }

  function closeModal() {
    modal.classList.add('hidden');
    document.body.classList.remove('overflow-hidden');
  }

  // star highlight
  document.addEventListener('click', (e) => {
    const btn = e.target.closest('[data-review-btn]');
    if (btn) {
      e.preventDefault();
      openModal(btn.getAttribute('data-product-id'), btn.getAttribute('data-product-name'));
      return;
    }
    if (e.target.matches('[data-modal-dismiss]')) {
      e.preventDefault(); closeModal(); return;
    }
    const star = e.target.closest('[data-star]');
    if (star) {
      const val = Number(star.getAttribute('value'));
      stars.forEach(s => s.classList.toggle('active', Number(s.getAttribute('value')) <= val));
      const radio = document.getElementById('rate-' + val);
      if (radio) radio.checked = true;
    }
  });

  function getCSRFToken() {
    const name = 'csrftoken=';
    const parts = document.cookie.split(';');
    for (let p of parts) {
      p = p.trim();
      if (p.startsWith(name)) return decodeURIComponent(p.substring(name.length));
    }
    return '';
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    msg.textContent = '';
    submitBtn.disabled = true;

    const fd = new FormData(form);
    try {
      const res = await fetch(endpoint, {
        method: 'POST',
        body: fd,
        headers: { 'X-CSRFToken': getCSRFToken() },
        credentials: 'same-origin'
      });
      const data = await res.json();

      if (data.ok) {
        msg.textContent = data.message || 'Saved.';
        msg.className = 'mt-3 text-sm text-green-600';
        // remove card from pending list
        const card = document.getElementById('pr-card-' + fd.get('product_id'));
        if (card) {
          card.classList.add('opacity-0', 'scale-[.98]', 'transition', 'duration-150');
          setTimeout(() => card.remove(), 160);
        }
        setTimeout(closeModal, 250);
      } else {
        msg.textContent = data.message || 'Could not submit review.';
        msg.className = 'mt-3 text-sm text-red-600';
      }
    } catch (err) {
      msg.textContent = 'Network error. Try again.';
      msg.className = 'mt-3 text-sm text-red-600';
      console.error(err);
    } finally {
      submitBtn.disabled = false;
    }
  });

  // ESC to close
  window.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && !modal.classList.contains('hidden')) closeModal();
  });
})();
</script>
{% endblock %}
