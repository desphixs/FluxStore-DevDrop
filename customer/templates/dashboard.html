{# templates/dashboard.html #}
{% extends "partials/customer/customer_navigation.html" %}

{% block customer_content %}
<!-- Page header -->
<div class="flex items-center justify-between mb-6">
  <div>
    <h1 class="text-2xl font-bold tracking-tight">Welcome back, {{ request.user.first_name|default:request.user.username }}</h1>
    <p class="text-sm text-gray-500">Here’s a quick snapshot of your account.</p>
  </div>
  <div class="flex items-center gap-2">
    <a href="{% url 'customer:orders' %}" class="inline-flex items-center gap-2 rounded-lg border border-gray-200 px-3 py-2 text-sm font-medium hover:bg-gray-50">
      <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24"><path d="M7 4h10l1 2h4v2h-1l-2 10H5L3 8H2V6h4l1-2zm2.1 4l-.5 2h6.8l-.5-2H9.1zM7 20a2 2 0 1 0 0-4 2 2 0 0 0 0 4zm10 0a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"/></svg>
      View all orders
    </a>
    <a href="{% url 'customer:wishlist' %}" class="inline-flex items-center gap-2 rounded-lg bg-gray-900 text-white px-3 py-2 text-sm font-semibold hover:bg-black">
      <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24"><path d="M12.1 21.35 10 19.28C5.4 15.36 2 12.28 2 8.5 2 6 4 4 6.5 4c1.74 0 3.41.81 4.5 2.09C12.59 4.81 14.26 4 16 4 18.5 4 20.5 6 20.5 8.5c0 3.78-3.4 6.86-8 10.78l-1.9 2.07z"/></svg>
      Wishlist
    </a>
  </div>
</div>

<!-- KPIs -->
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
  <!-- Total Orders -->
  <div class="rounded-2xl border border-gray-200 bg-white p-5">
    <div class="flex items-center justify-between">
      <p class="text-sm text-gray-500">Total Orders</p>
      <span class="inline-flex h-8 w-8 items-center justify-center rounded-lg bg-gray-100">
        <svg class="h-4 w-4 text-gray-700" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24"><path d="M3 3h18v2H3zM3 7h18v2H3zM3 11h18v2H3zM3 15h18v2H3zM3 19h18v2H3z"/></svg>
      </span>
    </div>
    <div class="mt-3 text-3xl font-bold">{{ stats.total_orders|default:0 }}</div>
    <p class="mt-1 text-xs text-gray-500">All-time</p>
  </div>

  <!-- Total Spent -->
  <div class="rounded-2xl border border-gray-200 bg-white p-5">
    <div class="flex items-center justify-between">
      <p class="text-sm text-gray-500">Total Spent</p>
      <span class="inline-flex h-8 w-8 items-center justify-center rounded-lg bg-gray-100">
        <svg class="h-4 w-4 text-gray-700" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24"><path d="M12 1a11 11 0 1 0 11 11A11.013 11.013 0 0 0 12 1zm.5 17.93V20h-1v-1.07A6.992 6.992 0 0 1 6 13h2a5 5 0 0 0 10 0 5 5 0 0 0-10 0H6a7 7 0 0 1 12-4h-1.54a3.5 3.5 0 1 0 0 2H18a7 7 0 0 1-5.5 5.93z"/></svg>
      </span>
    </div>
    <div class="mt-3 text-3xl font-bold">₹{{ stats.total_spent|floatformat:2 }}</div>
    <p class="mt-1 text-xs text-gray-500">Paid & not canceled/refunded</p>
  </div>

  <!-- Items Bought -->
  <div class="rounded-2xl border border-gray-200 bg-white p-5">
    <div class="flex items-center justify-between">
      <p class="text-sm text-gray-500">Items Bought</p>
      <span class="inline-flex h-8 w-8 items-center justify-center rounded-lg bg-gray-100">
        <svg class="h-4 w-4 text-gray-700" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24"><path d="M7 4h10l1 2h4v2h-1l-2 10H5L3 8H2V6h4l1-2z"/></svg>
      </span>
    </div>
    <div class="mt-3 text-3xl font-bold">{{ stats.total_items_bought|default:0 }}</div>
    <p class="mt-1 text-xs text-gray-500">Aggregate quantity</p>
  </div>

  <!-- Unpaid -->
  <div class="rounded-2xl border border-gray-200 bg-white p-5">
    <div class="flex items-center justify-between">
      <p class="text-sm text-gray-500">Unpaid Orders</p>
      <span class="inline-flex h-8 w-8 items-center justify-center rounded-lg bg-gray-100">
        <svg class="h-4 w-4 text-gray-700" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24"><path d="M12 1 3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 20c-3.86-1.12-7-5.24-7-9V6.3l7-3.11 7 3.11V12c0 3.76-3.14 7.88-7 9z"/></svg>
      </span>
    </div>
    <div class="mt-3 text-3xl font-bold">{{ stats.unpaid_orders|default:0 }}</div>
    <p class="mt-1 text-xs text-gray-500">₹{{ stats.unpaid_amount|floatformat:2 }}</p>
  </div>
</div>

<!-- Grid: Latest Orders + Wishlist -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
  <!-- Latest Paid Orders -->
  <section class="lg:col-span-2 rounded-2xl border border-gray-200 bg-white">
    <div class="px-5 py-4 flex items-center justify-between border-b border-gray-100">
      <h2 class="text-sm font-semibold tracking-wide">Recent paid orders</h2>
      <a href="{% url 'customer:orders' %}?show=paid" class="text-sm text-gray-600 hover:text-gray-900">See all</a>
    </div>

    {% if latest_paid %}
    <div class="overflow-x-auto">
      <table class="min-w-full text-sm">
        <thead class="text-left bg-gray-50">
          <tr class="text-gray-600">
            <th class="px-5 py-3 font-medium">Order</th>
            <th class="px-5 py-3 font-medium">Date</th>
            <th class="px-5 py-3 font-medium">Items</th>
            <th class="px-5 py-3 font-medium">Total</th>
            <th class="px-5 py-3 font-medium">Status</th>
            <th class="px-5 py-3"></th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-100">
          {% for o in latest_paid %}
          <tr class="hover:bg-gray-50">
            <td class="px-5 py-3">
              <div class="flex items-center gap-2">
                <span class="font-semibold">#{{ o.order_id }}</span>
                <button type="button" class="text-xs text-gray-400 hover:text-gray-600" onclick="navigator.clipboard.writeText('{{ o.order_id }}')">Copy</button>
              </div>
            </td>
            <td class="px-5 py-3 text-gray-600">{{ o.created_at|date:"M j, Y" }}</td>
            <td class="px-5 py-3 text-gray-600">
              {{ o.items.count }} item{{ o.items.count|pluralize }}
            </td>
            <td class="px-5 py-3 font-semibold">₹{{ o.amount_payable|floatformat:2 }}</td>
            <td class="px-5 py-3">
              {% if o.status == "DELIVERED" %}
                <span class="inline-flex items-center rounded-full bg-emerald-50 px-2.5 py-1 text-xs font-medium text-emerald-700">Delivered</span>
              {% elif o.status == "PROCESSING" %}
                <span class="inline-flex items-center rounded-full bg-blue-50 px-2.5 py-1 text-xs font-medium text-blue-700">Processing</span>
              {% elif o.status == "SHIPPED" %}
                <span class="inline-flex items-center rounded-full bg-indigo-50 px-2.5 py-1 text-xs font-medium text-indigo-700">Shipped</span>
              {% elif o.status == "PENDING" %}
                <span class="inline-flex items-center rounded-full bg-amber-50 px-2.5 py-1 text-xs font-medium text-amber-700">Pending</span>
              {% else %}
                <span class="inline-flex items-center rounded-full bg-gray-100 px-2.5 py-1 text-xs font-medium text-gray-700">{{ o.status|title }}</span>
              {% endif %}
            </td>
            <td class="px-5 py-3">
              <a href="{% url 'customer:order_detail' o.order_id %}"
                 class="inline-flex items-center gap-1 rounded-lg border border-gray-200 px-3 py-1.5 text-xs font-medium hover:bg-gray-50">
                View
                <svg class="h-3.5 w-3.5" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20"><path d="M7 4l6 6-6 6"/></svg>
              </a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
      <div class="p-6 text-center text-sm text-gray-500">No paid orders yet.</div>
    {% endif %}
  </section>

  <!-- Wishlist Preview -->
  <section class="rounded-2xl border border-gray-200 bg-white">
    <div class="px-5 py-4 flex items-center justify-between border-b border-gray-100">
      <h2 class="text-sm font-semibold tracking-wide">Wishlist</h2>
      <a href="{% url 'customer:wishlist' %}" class="text-sm text-gray-600 hover:text-gray-900">Manage</a>
    </div>

    {% if wishlist_preview %}
    <ul class="divide-y divide-gray-100">
      {% for it in wishlist_preview %}
        {% with p=it.product pv=it.product_variation %}
        <li class="p-4 flex items-center gap-3 hover:bg-gray-50">
          <div class="h-12 w-12 rounded-xl bg-gray-100 overflow-hidden flex items-center justify-center">
            {% if p.primary_image and p.primary_image.image %}
              <img src="{{ p.primary_image.image.url }}" alt="{{ p.name }}" class="h-full w-full object-cover">
            {% else %}
              <span class="text-xs text-gray-500">{{ p.name|truncatechars:2|upper }}</span>
            {% endif %}
          </div>
          <div class="min-w-0 flex-1">
            <div class="truncate font-medium text-sm">{{ p.name }}</div>
            <div class="text-xs text-gray-500 truncate">
              {% if pv %}Variant: {{ pv.variations.all|join:", " }}{% else %}Product{% endif %}
            </div>
          </div>
          <a href="{% url 'customer:wishlist' %}" class="text-xs font-medium text-gray-600 hover:text-gray-900">Details</a>
        </li>
        {% endwith %}
      {% endfor %}
    </ul>
    {% else %}
      <div class="p-6 text-center text-sm text-gray-500">No items in wishlist yet.</div>
    {% endif %}
  </section>
</div>

<!-- Helpful quick links -->
<div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
  <a href="{% url 'customer:orders' %}?show=unpaid" class="rounded-2xl border border-dashed border-gray-300 bg-white p-5 hover:border-gray-400">
    <div class="flex items-center justify-between">
      <p class="text-sm font-semibold">Pay outstanding</p>
      <span class="text-xs text-gray-500">Unpaid</span>
    </div>
    <p class="mt-1 text-2xl font-bold">₹{{ stats.unpaid_amount|floatformat:2 }}</p>
    <p class="mt-1 text-xs text-gray-500">{{ stats.unpaid_orders }} order{{ stats.unpaid_orders|pluralize }}</p>
  </a>

  <a href="{% url 'customer:pending_reviews' %}" class="rounded-2xl border border-dashed border-gray-300 bg-white p-5 hover:border-gray-400">
    <div class="flex items-center justify-between">
      <p class="text-sm font-semibold">Pending reviews</p>
      <span class="text-xs text-gray-500">Feedback</span>
    </div>
    <p class="mt-1 text-2xl font-bold">
      {# You can compute a count in view later; for now this stays a call to action #}
      Add yours →
    </p>
    <p class="mt-1 text-xs text-gray-500">Help others decide</p>
  </a>

  <a href="{% url 'customer:settings' %}" class="rounded-2xl border border-dashed border-gray-300 bg-white p-5 hover:border-gray-400">
    <div class="flex items-center justify-between">
      <p class="text-sm font-semibold">Account settings</p>
      <span class="text-xs text-gray-500">Profile</span>
    </div>
    <p class="mt-1 text-2xl font-bold">Update info</p>
    <p class="mt-1 text-xs text-gray-500">Name, email & addresses</p>
  </a>
</div>
{% endblock %}
