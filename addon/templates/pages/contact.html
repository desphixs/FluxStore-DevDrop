{% extends "base/base.html" %}
{% load static %}

{% block content %}
<main class="mx-auto max-w-3xl px-4 sm:px-6 lg:px-8 py-12  lg:mt-15 mt-5">
  <!-- Header -->
  <header class="mb-8">
    <h1 class="text-3xl font-bold text-gray-900">Contact Us</h1>
    <p class="mt-2 text-gray-600">Questions, feedback, or partnership ideas? Shoot us a message.</p>
  </header>

  <!-- Contact Form -->
  <section class="rounded-2xl border p-6">
    <form id="contact-form" class="space-y-5">
      {% csrf_token %}
      <div>
        <label for="name" class="block text-sm font-medium text-gray-700">Name</label>
        <input id="name" name="name" type="text" required
               class="mt-1 w-full rounded-lg border px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[#991b1b]" />
      </div>

      <div>
        <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
        <input id="email" name="email" type="email" required
               class="mt-1 w-full rounded-lg border px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[#991b1b]" />
      </div>

      <div>
        <label for="subject" class="block text-sm font-medium text-gray-700">Subject (optional)</label>
        <input id="subject" name="subject" type="text"
               class="mt-1 w-full rounded-lg border px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[#991b1b]" />
      </div>

      <div>
        <label for="message" class="block text-sm font-medium text-gray-700">Message</label>
        <textarea id="message" name="message" rows="5" required
                  class="mt-1 w-full rounded-lg border px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[#991b1b]"></textarea>
      </div>

      <label class="flex items-start gap-2 text-sm text-gray-700">
        <input id="consent" name="consent" type="checkbox" class="mt-1">
        I agree to be contacted about my request.
      </label>

      <div class="flex items-center gap-3">
        <button id="submit-btn" type="submit"
                class="inline-flex items-center justify-center rounded-lg bg-[#991b1b] px-5 py-2.5 text-white font-medium hover:opacity-90 disabled:opacity-60">
          <span id="btn-text">Send Message</span>
          <svg id="btn-spinner" class="ml-2 h-5 w-5 animate-spin hidden" viewBox="0 0 24 24" fill="none">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
          </svg>
        </button>
        <p id="form-status" class="text-sm"></p>
      </div>
    </form>
  </section>

  <!-- FAQs -->
  <section class="mt-10">
    <h2 class="text-xl font-semibold text-gray-900">FAQs</h2>
    {% if faqs %}
      <div class="mt-4 divide-y rounded-2xl border">
        {% for f in faqs %}
          <details class="group p-4 open:rounded-t-2xl last:open:rounded-b-2xl">
            <summary class="flex cursor-pointer list-none items-start justify-between gap-3">
              <span class="text-base font-medium text-gray-900">{{ f.question }}</span>
              <span class="mt-1 shrink-0 transition-transform group-open:rotate-180">
                <!-- caret -->
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m19 9-7 7-7-7"/>
                </svg>
              </span>
            </summary>
            <div class="mt-3 text-gray-700 leading-7">
              {{ f.answer|linebreaks }}
            </div>
          </details>
        {% endfor %}
      </div>
    {% else %}
      <p class="mt-3 text-gray-600">No FAQs yet. Ask us anything via the form above.</p>
    {% endif %}
  </section>
</main>

<script>
// --- CSRF helper ---
function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(";").shift();
  return null;
}
const csrftoken = getCookie('csrftoken');

// --- DOM refs ---
const form = document.getElementById('contact-form');
const btn = document.getElementById('submit-btn');
const btnText = document.getElementById('btn-text');
const spinner = document.getElementById('btn-spinner');
const statusEl = document.getElementById('form-status');

// --- UX helpers ---
function setSubmitting(isSubmitting) {
  btn.disabled = isSubmitting;
  spinner.classList.toggle('hidden', !isSubmitting);
  btnText.textContent = isSubmitting ? 'Sending...' : 'Send Message';
}
function setStatus(msg, ok = true) {
  statusEl.textContent = msg;
  statusEl.className = 'text-sm ' + (ok ? 'text-green-600' : 'text-red-600');
}

// --- Submit handler ---
form.addEventListener('submit', async (e) => {
  e.preventDefault();
  setStatus('');
  setSubmitting(true);

  const payload = {
    name: document.getElementById('name').value.trim(),
    email: document.getElementById('email').value.trim(),
    subject: document.getElementById('subject').value.trim(),
    message: document.getElementById('message').value.trim(),
    consent: document.getElementById('consent').checked,
  };

  try {
    const res = await fetch("{% url 'addon:contact_submit' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": csrftoken,
      },
      body: JSON.stringify(payload),
    });
    const data = await res.json();

    if (!res.ok || !data.ok) throw new Error(data.error || 'Something went wrong.');

    setStatus(data.message || 'Message sent!', true);
    form.reset();
  } catch (err) {
    setStatus(err.message || 'Failed to send message.', false);
  } finally {
    setSubmitting(false);
  }
});
</script>
{% endblock %}
