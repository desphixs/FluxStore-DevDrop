{% load static %}

<nav id="main-nav" class="fixed top-0 left-0 w-full z-50 text-[{{theme_settings.header_text_color}}]"
    data-homepage="{% if is_homepage %}true{% elif request.path == '/' %}true{% else %}false{% endif %}">

    <div id="top-bar"
        class="hidden md:flex justify-between items-center px-6 py-2 text-sm border-b border-transparent transition-all duration-300">
        <div class="flex space-x-4">
            <a href="#" class="hover:underline">About Us </a>
            <a href="{% url 'customer:dashboard' %}" class="hover:underline">My Account</a>
            <a href="#" class="hover:underline">Wishlist</a>
            <a href="#" class="hover:underline">Order Tracking</a>
        </div>
        <div class="flex items-center space-x-4">
            <span>Need help? Call Us: <span class="text-yellow-400 font-bold">{{site_config.phone}}</span></span>
            
        </div>
    </div>

    <div id="main-nav-content"
        class="flex items-center justify-between px-4 md:px-6 py-3 border-t border-white/20 transition-all duration-300">
        <button id="hamburger-btn" class="md:hidden text-2xl">
            <i class="fa fa-bars"></i>
        </button>
        <a href="{% url 'store:index' %}">
            <img src="{{site_config.site_logo.url}}" alt="Logo" class="object-contain w-32 md:w-[18rem]">
        </a>
        <div id="search-container" class="hidden md:flex items-center border border-white rounded-md overflow-hidden">
            <select class="bg-transparent px-2 py-2 focus:outline-none">
                <option class="bg-black">All Categories </option>
            </select>
            <input type="text" placeholder="Search for items..."
                class="bg-transparent placeholder-white-light px-3 py-2 w-64 focus:outline-none">
            <button class="px-4">
                <i class="fa fa-search"></i>
            </button>
        </div>

        <div class="flex items-center space-x-4 md:space-x-6">
           
            <a href="#" class="relative flex items-center">
                <i class="fa fa-heart mr-1"></i> <span class="hidden md:inline">Wishlist</span>
                <span class="absolute -top-2 -right-3 bg-[#B01F00] text-xs rounded-full px-2">6</span>
            </a>
            <a href="{% url 'store:cart' %}" class="relative flex items-center">
                <i class="fa fa-shopping-cart mr-1"></i> <span class="hidden md:inline">Cart</span>
                <span class="absolute -top-2 -right-3 bg-[#B01F00] text-xs rounded-full px-2">
                    <span class="cart_item_count">
                        {{cart_item_count|default:"0"}}
                    </span>
                </span>
            </a>
            
            {% if request.user.is_authenticated %}
                <a href="{% url 'customer:dashboard' %}" class="hidden md:flex items-center">
                    <i class="fa fa-user me-2"></i> Account
                </a>
                <a href="{% url 'userauths:logout' %}" class="hidden md:flex items-center">
                    <i class="fa fa-power-off mr-1"></i> 
                </a>
            {% else %}
            <a href="{% url 'userauths:login' %}" class="hidden md:flex items-center">
                <i class="fa fa-sign-in-alt mr-1"></i> Login
            </a>
            {% endif %}
                
        </div>
    </div>

    <div id="bottom-bar"
        class="hidden md:flex items-center justify-between px-6 py-2 border-t border-white/20 transition-all duration-300">
        <button class="bg-[#B01F00] px-4 py-2 rounded-md flex items-center hover:bg-red-800 transition-colors">
            <i class="fa fa-list mr-2"></i> Browse All Categories
        </button>
        <div id="desktop-links" class="flex space-x-6">
            <a href="#">Men</a>
            <a href="#">Kids</a>
            <a href="#">Deals</a>
            <a href="#">Home</a>
            <a href="#">About</a>
            <a href="#">Shop</a>
            <a href="#">Vendors</a>
            <a href="#">Mega menu</a>
            <a href="#">Contact</a>
        </div>
        <div class="flex items-center space-x-2">
            <i class="fa fa-headphones text-2xl"></i>
            <div>
                <div class="text-yellow-400 font-bold"></div>
                <div class="text-xs">24/7 Support Center</div>
            </div>
        </div>
    </div>
</nav>

<div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-[60] hidden"></div>
<div id="sidebar" class="fixed top-0 left-0 w-64 h-full bg-white shadow-lg z-[70] p-6 sidebar-hidden text-gray-800">
    <button id="close-sidebar-btn" class="absolute top-4 right-4 text-2xl">&times;</button>
    <h2 class="text-xl font-bold mb-6">Menu</h2>
    <div id="sidebar-links" class="flex flex-col space-y-4"></div>
</div>


<script>
    // --- helper: safe getElementById or null ---
const $ = (id) => document.getElementById(id);
const NAV_BG_COLOR = "{{ theme_settings.header_bg_color }}";


document.addEventListener("DOMContentLoaded", () => {
    const nav = $("main-nav");
    if (!nav) return;

    // read homepage flag set by template (true/false)
    const isHomepage = nav.dataset.homepage === "true";

    // Common elements (may be missing on some pages)
    const topBar = $("top-bar");
    const mainNavContent = $("main-nav-content");
    const bottomBar = $("bottom-bar");
    const hamburgerBtn = $("hamburger-btn");
    const sidebar = $("sidebar");
    const sidebarOverlay = $("sidebar-overlay");
    const closeSidebarBtn = $("close-sidebar-btn");
    const sidebarLinksContainer = $("sidebar-links");
    const desktopLinks = document.getElementById("desktop-links");
    const startShoppingBtn = $("start-shopping-btn");
    const allNavLinks = document.querySelectorAll("nav a");

    // hero & main content are only expected on homepage
    const videoHero = $("video-hero");
    const mainContent = $("main-content");

    // Safety: populate sidebar links by cloning desktop links (only if both exist)
    if (sidebarLinksContainer && desktopLinks) {
        const clone = desktopLinks.cloneNode(true);
        sidebarLinksContainer.innerHTML = clone.innerHTML;
    }

    // Sidebar open/close
    const openSidebar = () => {
        if (sidebar) sidebar.classList.remove("sidebar-hidden");
        if (sidebarOverlay) sidebarOverlay.classList.remove("hidden");
    };
    const closeSidebar = () => {
        if (sidebar) sidebar.classList.add("sidebar-hidden");
        if (sidebarOverlay) sidebarOverlay.classList.add("hidden");
    };
    if (hamburgerBtn) hamburgerBtn.addEventListener("click", openSidebar);
    if (closeSidebarBtn) closeSidebarBtn.addEventListener("click", closeSidebar);
    if (sidebarOverlay) sidebarOverlay.addEventListener("click", closeSidebar);

    // Modal safe listeners (if modal exists)
    const dealsModal = $("deals-modal");
    const modalOverlay = $("deals-modal-overlay");
    const closeModalBtn = $("close-modal-btn");
    const showModal = () => {
        if (dealsModal) dealsModal.classList.remove("modal-hidden");
        if (modalOverlay) modalOverlay.classList.remove("modal-hidden");
    };
    const hideModal = () => {
        if (dealsModal) dealsModal.classList.add("modal-hidden");
        if (modalOverlay) modalOverlay.classList.add("modal-hidden");
    };

    if (closeModalBtn) closeModalBtn.addEventListener("click", hideModal);
    if (modalOverlay) modalOverlay.addEventListener("click", hideModal);

    // Style helpers
    const applyScrolledNavStyles = () => {
        nav.style.backgroundColor = NAV_BG_COLOR;
        nav.classList.add("shadow-lg");
    };
    const applyTransparentNavStyles = () => {
        nav.style.backgroundColor = "transparent";
        nav.classList.remove("shadow-lg");
    };
    const showAllNav = () => {
        if (window.innerWidth >= 768) {
            if (topBar) topBar.style.display = "flex";
            if (bottomBar) bottomBar.style.display = "flex";
        }
    };
    const hideNavParts = () => {
        if (window.innerWidth >= 768) {
            if (topBar) topBar.style.display = "none";
            if (bottomBar) bottomBar.style.display = "none";
        }
    };

    // fast smooth scroll
    const fastScrollTo = (target, duration = 400) => {
        const targetPosition = typeof target === "number" ? target : (target && target.offsetTop) || 0;
        const startPosition = window.pageYOffset;
        const distance = targetPosition - startPosition;
        let startTime = null;
        const animation = (currentTime) => {
            if (startTime === null) startTime = currentTime;
            const timeElapsed = currentTime - startTime;
            const run = Math.min(1, timeElapsed / duration);
            const easedProgress = run < 1 ? run * (2 - run) : 1;
            const newPosition = startPosition + distance * easedProgress;
            window.scrollTo(0, newPosition);
            if (timeElapsed < duration) requestAnimationFrame(animation);
        };
        requestAnimationFrame(animation);
    };

    // Nav links behaviour: scroll to main content (if present)
    // const handleNavLinkClick = (e) => {
    //     // if link is external or has target, don't override
    //     if (e.currentTarget.target && e.currentTarget.target !== "") return;
    //     e.preventDefault();
    //     if (mainContent) fastScrollTo(mainContent, 500);
    //     closeSidebar();
    // };
    // allNavLinks.forEach((link) => link.addEventListener("click", handleNavLinkClick));
    // if (sidebarLinksContainer) {
    //     sidebarLinksContainer.querySelectorAll("a").forEach((link) => link.addEventListener("click", handleNavLinkClick));
    // }
    if (startShoppingBtn) startShoppingBtn.addEventListener("click", () => fastScrollTo(mainContent, 500));

    // If this page is NOT homepage -> set minimized header by default and skip scroll-snap logic
    if (!isHomepage) {
        // set to scrolled/minimized header state
        applyScrolledNavStyles();
        hideNavParts();

        // keep expand-on-hover behavior
        nav.addEventListener("mouseenter", () => {
            nav.style.backgroundColor = NAV_BG_COLOR;
            showAllNav();
        });
        nav.addEventListener("mouseleave", () => {
            nav.style.backgroundColor = NAV_BG_COLOR;
            hideNavParts();
        });
        return; // done for non-home pages
    }

    // --- homepage-only behaviour starts here ---
    // Guards for hero / mainContent existence
    if (!videoHero || !mainContent) {
        // If hero/mainContent missing (unexpected), fallback to minimized header behavior
        applyTransparentNavStyles();
        showAllNav();
        return;
    }

    // snap behaviour variables
    let snapDownLock = false;
    let snapUpLock = false;
    let lastScrollY = window.scrollY || 0;

    window.addEventListener("scroll", () => {
        const currentScrollY = window.scrollY || 0;
        const scrollingDown = currentScrollY > lastScrollY;
        const scrollingUp = currentScrollY < lastScrollY;
        const heroHeight = Math.max(0, videoHero.offsetHeight || 0);

        // fade hero with scroll
        const fadeEnd = heroHeight * 0.8;
        const scrollPercentage = fadeEnd > 0 ? Math.min(1, currentScrollY / fadeEnd) : 1;
        videoHero.style.opacity = String(1 - scrollPercentage);

        // snap scroll (only on larger screens as before)
        if (window.innerWidth > 768) {
            if (scrollingDown && currentScrollY > 0 && currentScrollY < heroHeight / 2 && !snapDownLock) {
                snapDownLock = true;
                snapUpLock = false;
                fastScrollTo(mainContent, 500);
            }
            if (scrollingUp && currentScrollY < heroHeight - 10 && !snapUpLock) {
                snapUpLock = true;
                snapDownLock = false;
                fastScrollTo(0, 500);
            }
        }

        lastScrollY = currentScrollY <= 0 ? 0 : currentScrollY;

        // header minimize & show-on-hover
        if (window.scrollY > 50) {
            applyScrolledNavStyles();
            if (!nav.matches(":hover")) {
                hideNavParts();
            }
        } else {
            applyTransparentNavStyles();
            showAllNav();
        }
    });

    // hover behavior (homepage)
    nav.addEventListener("mouseenter", () => {
        if (window.scrollY > 50) {
            nav.style.backgroundColor = NAV_BG_COLOR;
            showAllNav();
        }
    });
    nav.addEventListener("mouseleave", () => {
        if (window.scrollY > 50) {
            nav.style.backgroundColor = NAV_BG_COLOR;
            hideNavParts();
        }
    });
    // --- end homepage-only behaviour ---
});


</script>