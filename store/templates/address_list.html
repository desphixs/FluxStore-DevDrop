{% extends 'base/base.html' %}
{% load static %}
{% block content %}

<div class=" min-h-screen py-10 sm:py-16 mt-32">
  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
    
    <div class="mb-8 text-center sm:text-left">
      <h1 class="text-3xl sm:text-4xl font-bold tracking-tight text-slate-800">Manage Addresses</h1>
      <p class="mt-2 text-base text-slate-500">Add, edit, or select your default shipping address.</p>
    </div>

    <details class="bg-white border rounded-lg shadow-sm open:ring-1 open:ring-black/5 mb-8">
      <summary class="py-4 px-6 font-medium text-slate-700 cursor-pointer list-none flex items-center justify-between">
        <span>Add a New Address</span>
        <svg class="w-5 h-5 text-slate-500 transition-transform duration-300 transform open:-rotate-180" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" />
        </svg>        
      </summary>
      <div class="border-t border-slate-200 p-6">
        
        <form method="post" class="grid grid-cols-1 gap-y-6 sm:grid-cols-2 sm:gap-x-8">
            {% csrf_token %}
            
            {% for field in form %}
            <div class="{% if field.name == 'street_address' %}sm:col-span-2{% endif %}">
                <label for="{{ field.id_for_label }}" class="block text-sm font-medium text-slate-700">{{ field.label }}</label>
                <div class="mt-1">
                    {{ field }}
                </div>
                {% if field.errors %}
                <p class="mt-2 text-sm text-red-600">{{ field.errors|striptags }}</p>
                {% endif %}
            </div>
            {% endfor %}

            <div class="sm:col-span-2">
                <button type="submit" class="w-full sm:w-auto inline-flex items-center justify-center rounded-md border border-transparent bg-indigo-600 px-6 py-2 text-base font-medium text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                    Add Address
                </button>
            </div>
        </form>
      </div>
    </details>

    <div class="bg-white rounded-lg shadow-sm">
      <div class="divide-y divide-slate-200">
        {% for address in addresses %}
          <div class="p-6 flex flex-col sm:flex-row justify-between gap-4 border" id="address-{{ address.uuid }}">
            <div class="flex items-start gap-x-4">
              <svg class="h-6 w-6 text-slate-400 flex-shrink-0 mt-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                  <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1 1 15 0Z" />
              </svg>

              <div>
                <div class="flex items-center gap-x-3">
                  <p class="text-sm font-semibold text-slate-800">{{ address.street_address }}</p>
                  {% if address.is_default %}
                    <span class="inline-flex items-center rounded-full bg-green-100 px-2.5 py-0.5 text-xs font-medium text-green-800">Default</span>
                  {% endif %}
                </div>
                <p class="mt-1 text-sm text-slate-500">{{ address.city }}, {{ address.state }} {{ address.postal_code }}</p>
                <p class="mt-1 text-sm text-slate-500">{{ address.country }}</p>
              </div>
            </div>

            <div class="flex-shrink-0 self-start sm:self-center">
              {% if not address.is_default %}
                <button 
                  class="set-default text-sm font-semibold text-indigo-600 hover:text-indigo-500"
                  data-uuid="{{ address.uuid }}">
                  Set as Default
                </button>
              {% endif %}
            </div>
          </div>
        {% empty %}
          <div class="text-center py-16 px-6">
            <svg class="mx-auto h-12 w-12 text-slate-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 21v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21m0 0h4.5V3.545M12.75 21h7.5V10.75M2.25 21h1.5m18 0h-18M2.25 9l4.5-1.636M18.75 3l-1.5.545m0 6.205 3 1m-3-1L6 3m12 6.205-3-1m-3 1 3-1" />
            </svg>
            <h3 class="mt-2 text-lg font-semibold text-slate-800">No addresses found</h3>
            <p class="mt-1 text-sm text-slate-500">Get started by adding a new shipping address.</p>
          </div>
        {% endfor %}
      </div>
    </div>

    <a href="{% url 'store:cart' %}" class="btn bg-[#B11E05] text-white mt-10"> <i class="fas fa-arrow-left me-2"></i> Back to cart</a>

  </div>
</div>

<script>
// Your existing JavaScript works perfectly with this new structure.
document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll(".set-default").forEach(btn => {
    btn.addEventListener("click", async () => {
      const uuid = btn.dataset.uuid;
      // Using a modern approach to get the CSRF token
      const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
      
      const res = await fetch(`/addresses/${uuid}/set-default/`, {
        method: "POST",
        headers: {
          "X-CSRFToken": csrfToken,
          "X-Requested-With": "XMLHttpRequest",
          "Content-Type": "application/json"
        }
      });

      const data = await res.json();
      if (data.success) {
        // Reloading is simple and effective.
        location.reload();
      } else {
        alert("Failed to set default address.");
      }
    });
  });
});
</script>

{% endblock %}