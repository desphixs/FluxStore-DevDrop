{% extends 'base/base.html' %}
{% load static %}
{% block content %}


    <div class="max-w-7xl mx-auto px-4 py-8 bg-white text-gray-800 mt-32">
        <div class="grid grid-cols-1 md:grid-cols-12 gap-8">

            <!-- LEFT: Gallery -->
            <div class="md:col-span-6">
                <div class="bg-white rounded-xl shadow p-4">
                    <div id="gallery-main" class="relative">
                        <!-- main image -->
                        <img id="main-image"
                            src="{% if product.primary_image %}{{ product.primary_image.image.url }}{% elif product.general_images %}{{ product.general_images.0.image.url }}{% else %}{% static 'img/placeholder.png' %}{% endif %}"
                            alt="{{ product.name }}" class="w-full h-[24rem] object-contain rounded-lg" />

                        <!-- badge / countdown -->
                        <div id="deal-badge" class="absolute top-4 left-4">
                            {% comment %} default hidden, JS will show if active {% endcomment %}
                        </div>
                    </div>

                    <!-- thumbnails -->
                    <div class="mt-4 flex gap-3 overflow-x-auto">
                        <!-- variation images first -->
                        {% for v in product.active_variations %}
                        {% for img in v.images.all %}
                        <button class="thumb shrink-0 rounded-lg overflow-hidden border" data-src="{{ img.image.url }}">
                            <img src="{{ img.image.url }}" class="w-20 h-20 object-cover">
                        </button>
                        {% endfor %}
                        {% endfor %}

                        <!-- general images -->
                        {% for img in product.general_images %}
                        <button class="thumb shrink-0 rounded-lg overflow-hidden border" data-src="{{ img.image.url }}">
                            <img src="{{ img.image.url }}" class="w-20 h-20 object-cover">
                        </button>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- RIGHT: Details -->
            <div class="md:col-span-6">
                <div class="bg-white rounded-xl shadow p-6">
                    <!-- title & badges -->
                    <div class="flex items-start justify-between gap-4">
                        <div>
                            <h1 class="text-2xl font-bold">{{ product.name }}</h1>
                            <p class="text-sm text-gray-500 mt-1">By <span class="text-yellow-500">{{
                                    product.vendor.vendor_profile.business_name }}</span></p>
                        </div>
                        <div class="text-right">
                            <!-- rating -->
                            <div class="flex items-center">
                                <div class="text-yellow-400 mr-2">
                                    {% with rating=average_rating|floatformat:0|add:"0" %}
                                    {% for i in "12345" %}
                                    {% if forloop.counter <= rating %}★{% else %}☆{% endif %} {% endfor %} {% endwith %}
                                        </div>
                                        <div class="text-sm text-gray-500">({{ average_rating }})</div>
                                </div>
                            </div>
                        </div>

                       
<div class="mt-4 flex items-center gap-4">
    <div id="price-block">

        {# Regular Price (crossed out if discount applies) #}
        <div 
            id="display-regular-price" 
            class="text-sm text-gray-400 line-through"
            {% if not product.primary_item or product.primary_item.regular_price <= product.primary_item.sale_price %}
                style="display:none"
            {% endif %}
        >
            {% if product.primary_item %}
                ₦{{ product.primary_item.regular_price }}
            {% endif %}
        </div>

        {# Discount Badge (JS will toggle visibility) #}
        <div 
            id="discount-badge" 
            class="mt-2 text-sm font-semibold text-red-600 hidden">
        </div>
    </div>

    <div id="variation-label-badge"></div>
</div>


                        <!-- Variation selectors -->
                        <div class="mt-6 space-y-4">
                            {% for category, options in variation_options.items %}
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">{{ category }}</label>
                                <div class="flex gap-2">
                                    {% for opt in options %}
                                    <button type="button" class="variation-option px-3 py-1 rounded-md border text-sm"
                                        data-cat="{{ category }}" data-val="{{ opt }}">
                                        {{ opt }}
                                    </button>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>

                        <!-- stock + add to cart -->
                        <div class="mt-6 flex items-center gap-4">
                            <div id="stock-text" class="text-sm text-gray-600">In stock</div>
                            <div class="ml-auto flex gap-2">
                                <button id="decrease-qty" class="px-3 py-1 border rounded">-</button>
                                <input id="qty" type="number" value="1" min="1"
                                    class="w-16 text-center border rounded" />
                                <button id="increase-qty" class="px-3 py-1 border rounded">+</button>
                            </div>
                        </div>

                        <div class="mt-6 flex gap-3">
                            <button id="add-to-cart"
                                class="add-to-cart bg-yellow-500 hover:bg-yellow-600 text-white px-5 py-3 rounded font-semibold">
                                Add to Cart
                            </button>

                            <button id="buy-now" class="bg-gray-800 text-white px-5 py-3 rounded">Buy Now</button>
                        </div>

                        <!-- short description -->
                        <div class="mt-6 text-sm text-gray-700">
                            {{ product.description|safe }}
                        </div>
                    </div>

                    <!-- Reviews block -->
                    <div class="bg-white rounded-xl shadow p-6 mt-6">
                        <h3 class="font-semibold">Reviews ({{ reviews.count }})</h3>
                        <div class="mt-3 space-y-3">
                            {% for r in reviews %}
                            <div class="border-b pb-3">
                                <div class="flex items-center justify-between">
                                    <div class="text-sm font-semibold">{{ r.user.get_full_name|default:r.user.email }}
                                    </div>
                                    <div class="text-sm text-gray-500">{{ r.created_at|date:"M j, Y" }}</div>
                                </div>
                                <div class="text-sm text-yellow-400 mt-1">
                                    {% with rating=r.rating %}
                                    {% for i in "12345" %}
                                    {% if forloop.counter <= rating %}★{% else %}☆{% endif %} {% endfor %} {% endwith %}
                                        </div>
                                        <div class="mt-2 text-sm text-gray-700">{{ r.comment }}</div>
                                </div>
                                {% empty %}
                                <div class="text-sm text-gray-500">No reviews yet.</div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Related products -->
                        <div class="bg-white rounded-xl shadow p-6 mt-6">
                            <h3 class="font-semibold">Related Products</h3>
                            <div class="grid grid-cols-2 gap-4 mt-4">
                                {% for rp in related_products %}
                                <a href="{% url 'product_detail' rp.slug %}" class="block bg-gray-50 rounded p-3">
                                    <img src="{{ rp.primary_image.image.url }}"
                                        class="w-full h-28 object-cover rounded mb-2">
                                    <div class="text-sm font-semibold">{{ rp.name }}</div>
                                </a>
                                {% endfor %}
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <!-- embed variation map safely -->
            <script id="variation-map" type="application/json">{{ variation_map_json|safe }}</script>

            <script>
                /* ---------- Helpers ---------- */
                const variationMap = JSON.parse(document.getElementById('variation-map').textContent || '{}');

                function keyFromSelections(selections) {
                    // selections -> { "Color": "Red", "Size": "M" }
                    // create deterministic key sorted by category name
                    const arr = Object.keys(selections).sort((a, b) => a.localeCompare(b)).map(k => `${k}:${selections[k]}`);
                    return arr.join('|');
                }

                function formatCurrency(n) {
                    // naive formatting - replace with Intl if you want
                    return '₦' + Number(n).toLocaleString();
                }

                /* ---------- Gallery (click thumbnails to change main image) ---------- */
                document.addEventListener('click', function (e) {
                    const thumb = e.target.closest('.thumb');
                    if (thumb) {
                        const src = thumb.dataset.src;
                        const main = document.getElementById('main-image');
                        main.src = src;
                    }
                });

                /* ---------- Variation selection ---------- */
                const selections = {}; // current selected options

                document.querySelectorAll('.variation-option').forEach(btn => {
                    btn.addEventListener('click', function () {
                        const cat = this.dataset.cat;
                        const val = this.dataset.val;

                        // toggle selection UX
                        document.querySelectorAll(`.variation-option[data-cat="${cat}"]`).forEach(b => b.classList.remove('bg-gray-800', 'text-white'));
                        this.classList.add('bg-gray-800', 'text-white');

                        selections[cat] = val;
                        onSelectionChange();
                    });
                });

                function onSelectionChange() {
                    const key = keyFromSelections(selections);
                    const variant = variationMap[key];

                    const priceEl = document.getElementById('display-sale-price');
                    const regEl = document.getElementById('display-regular-price');
                    const discountBadge = document.getElementById('discount-badge');
                    const labelBadge = document.getElementById('variation-label-badge');
                    const stockText = document.getElementById('stock-text');

                    if (!variant) {
                        // no matching variant: show OOS or message
                        priceEl.textContent = 'Unavailable';
                        regEl.style.display = 'none';
                        discountBadge.classList.add('hidden');
                        stockText.textContent = 'Variant unavailable';
                        // disable add to cart
                        document.getElementById('add-to-cart').disabled = true;
                        return;
                    }

                    // update price
                    priceEl.textContent = formatCurrency(variant.sale_price);
                    if (variant.regular_price > variant.sale_price) {
                        regEl.textContent = formatCurrency(variant.regular_price);
                        regEl.style.display = 'block';
                        discountBadge.textContent = `Save ${variant.discount_percentage}% (₦${variant.discount_amount})`;
                        discountBadge.classList.remove('hidden');
                    } else {
                        regEl.style.display = 'none';
                        discountBadge.classList.add('hidden');
                    }

                    // update label badge
                    if (variant.label) {
                        labelBadge.innerHTML = `<span class="px-2 py-1 rounded text-sm font-semibold ${variant.label_color}">${variant.label}</span>`;
                    } else {
                        labelBadge.innerHTML = '';
                    }

                    // update stock
                    stockText.textContent = variant.stock_quantity > 0 ? `${variant.stock_quantity} in stock` : 'Out of stock';
                    document.getElementById('add-to-cart').disabled = variant.stock_quantity <= 0;

                    // update gallery images if variant has images
                    if (variant.images && variant.images.length) {
                        document.getElementById('main-image').src = variant.images[0];
                        // optionally swap thumbnails - skipping for simplicity
                    }

                    // update countdown badge if deal exists
                    const badgeWrap = document.getElementById('deal-badge');
                    badgeWrap.innerHTML = '';
                    if (variant.deal_active && variant.deal_ends_at) {
                        // show countdown UI inside badgeWrap and set data attributes for the countdown function
                        badgeWrap.innerHTML = `
      <div class="bg-red-600 text-white px-3 py-1 rounded">
        <div class="text-xs">Deal ends in</div>
        <div class="text-sm font-bold" data-deal-end="${variant.deal_ends_at}"></div>
      </div>`;
                        // initCountdown will pick up and run
                        initSingleCountdown(badgeWrap.querySelector('[data-deal-end]'));
                    }
                }

                /* ---------- Basic single countdown for product page badge ---------- */
                let countdownInterval = null;
                function initSingleCountdown(el) {
                    if (!el) return;
                    // parse iso
                    const end = new Date(el.dataset.dealEnd || el.getAttribute('data-deal-end'));
                    if (isNaN(end)) return;
                    if (countdownInterval) clearInterval(countdownInterval);

                    function update() {
                        const now = new Date();
                        const diff = end - now;
                        if (diff <= 0) {
                            el.textContent = 'Expired';
                            clearInterval(countdownInterval);
                            return;
                        }
                        const s = Math.floor(diff / 1000);
                        const days = Math.floor(s / (3600 * 24));
                        const hours = Math.floor((s % (3600 * 24)) / 3600);
                        const mins = Math.floor((s % 3600) / 60);
                        const secs = Math.floor(s % 60);
                        el.textContent = `${days}d ${hours}h ${mins}m`;
                    }
                    update();
                    countdownInterval = setInterval(update, 1000);
                }

                /* ---------- Qty handlers ---------- */
                document.getElementById('increase-qty').addEventListener('click', () => {
                    const q = document.getElementById('qty'); q.value = Math.min(Number(q.value) + 1, 999);
                });
                document.getElementById('decrease-qty').addEventListener('click', () => {
                    const q = document.getElementById('qty'); q.value = Math.max(Number(q.value) - 1, 1);
                });

                /* ---------- Add to Cart (AJAX example) ---------- */
                document.getElementById('add-to-cart').addEventListener('click', async () => {
                    const key = keyFromSelections(selections);
                    const variant = variationMap[key];
                    if (!variant) { alert('Select a valid variant'); return; }
                    const qty = Number(document.getElementById('qty').value || 1);

                    try {
                        const res = await fetch("", {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': '{{ csrf_token }}'
                            },
                            body: JSON.stringify({ variation_id: variant.id, quantity: qty })
                        });
                        const data = await res.json();
                        if (res.ok) {
                            // success: update cart UI
                            alert('Added to cart');
                        } else {
                            alert(data.detail || 'Could not add to cart');
                        }
                    } catch (err) {
                        console.error(err);
                        alert('Network error');
                    }
                });
            </script>

{% endblock content %}