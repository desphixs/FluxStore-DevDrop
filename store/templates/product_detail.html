{% extends 'base/base.html' %}
{% load static %}
{% block content %}


<style>
    .glide__arrows,
.glide__bullets {
  display: none !important;
}
</style>



    <div class="max-w-7xl mx-auto px-4 py-8 bg-white text-gray-800 mt-32">
        <div class="grid grid-cols-1 md:grid-cols-12 gap-8">

            <!-- LEFT: Gallery -->
            <div class="md:col-span-6">
                <!-- <div class="bg-white rounded-xl shadow p-4">
                    <div id="gallery-main" class="relative">
                        <img id="main-image"
                            src="{% if product.primary_image %}{{ product.primary_image.image.url }}{% elif product.general_images %}{{ product.general_images.0.image.url }}{% else %}{% static 'img/placeholder.png' %}{% endif %}"
                            alt="{{ product.name }}" class="w-full h-[24rem] object-contain rounded-lg" />

                        <div id="deal-badge" class="absolute top-4 left-4">
                            {% comment %} default hidden, JS will show if active {% endcomment %}
                        </div>
                    </div>

                    <div class="mt-4 flex gap-3 overflow-x-auto">
                        {% for v in product.active_variations %}
                        {% for img in v.images.all %}
                        <button class="thumb shrink-0 rounded-lg overflow-hidden border" data-src="{{ img.image.url }}">
                            <img src="{{ img.image.url }}" class="w-20 h-20 object-cover">
                        </button>
                        {% endfor %}
                        {% endfor %}

                        {% for img in product.general_images %}
                        <button class="thumb shrink-0 rounded-lg overflow-hidden border" data-src="{{ img.image.url }}">
                            <img src="{{ img.image.url }}" class="w-20 h-20 object-cover">
                        </button>
                        {% endfor %}
                    </div>
                </div> -->

                <div class="bg-white  p-4">
  <!-- MAIN IMAGE -->
  <div id="gallery-main" class="relative">
    <img id="main-image"
      src="{% if product.primary_image %}{{ product.primary_image.image.url }}{% elif product.general_images %}{{ product.general_images.0.image.url }}{% else %}{% static 'img/placeholder.png' %}{% endif %}"
      alt="{{ product.name }}"
      class="w-full h-[24rem] object-contain rounded-lg"
    />
    <div id="deal-badge" class="absolute top-4 left-4"></div>
  </div>

  <!-- THUMBNAILS WITH GLIDE -->
  <div class="mt-4 rounded-xl shadow py-3">
    <div class="glide" id="thumbs-carousel">
      <div class="glide__track" data-glide-el="track">
        <ul class="glide__slides flex gap-3 ">
          <!-- variation images first -->
          {% for v in product.active_variations %}
            {% for img in v.images.all %}
              <li class="glide__slide">
                <button class="thumb shrink-0 rounded-lg overflow-hidden border" data-src="{{ img.image.url }}">
                  <img src="{{ img.image.url }}" class="w-20 h-20 object-cover">
                </button>
              </li>
            {% endfor %}
          {% endfor %}
          <!-- general images -->
          {% for img in product.general_images %}
            <li class="glide__slide">
              <button class="thumb shrink-0 rounded-lg overflow-hidden border" data-src="{{ img.image.url }}">
                <img src="{{ img.image.url }}" class="w-20 h-20 object-cover">
              </button>
            </li>
          {% endfor %}
        </ul>
      </div>
      <div class="glide__arrows" data-glide-el="controls">
        <button class="glide__arrow glide__arrow--left" data-glide-dir="<">‹</button>
        <button class="glide__arrow glide__arrow--right" data-glide-dir=">">›</button>
      </div>
    </div>
  </div>

  <!-- MODAL -->
<div id="imageModal" class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center z-50">
  <span id="modalClose" class="absolute top-5 right-8 text-white text-3xl cursor-pointer">&times;</span>
  <img id="modalImage" class="max-w-4xl max-h-[90vh] object-contain rounded-lg shadow-lg cursor-zoom-out" />
</div>
</div>

            </div>

            <!-- RIGHT: Details -->
            <div class="md:col-span-6">
                <div class="bg-white rounded-xl shadow p-6">
                    <!-- title & badges -->
                    <div class="flex items-start justify-between gap-4">
                        <div>
                            <h1 class="text-2xl font-bold">{{ product.name }}</h1>
                            <p class="text-sm text-gray-500 mt-1">By <span class="text-[#B01F00]">{{ product.vendor.vendor_profile.business_name }}</span></p>
                        </div>
                        <div class="text-right">
                            <!-- rating -->
                            <div class="flex items-center">
                                <div class="text-yellow-400 mr-2">
                                    {% with rating=average_rating|floatformat:0|add:"0" %}
                                    {% for i in "12345" %}
                                    {% if forloop.counter <= rating %}★{% else %}☆{% endif %} {% endfor %} {% endwith %}
                                        </div>
                                        <div class="text-sm text-gray-500">({{ average_rating }})</div>
                                </div>
                            </div>
                        </div>

                       
<div class="mt-4 flex items-center gap-4">
    <div id="price-block">

        {# Regular Price (crossed out if discount applies) #}
        <div 
            id="display-regular-price" 
            class="text-sm text-gray-400 line-through"
            {% if not product.primary_item or product.primary_item.regular_price <= product.primary_item.sale_price %}
                style="display:none"
            {% endif %}
        >
            {% if product.primary_item %}
                ${{ product.primary_item.regular_price }}
            {% endif %}
        </div>

        {# Discount Badge (JS will toggle visibility) #}
        <div 
            id="discount-badge" 
            class="mt-2 text-sm font-semibold text-red-600 hidden">
        </div>
    </div>

    <div id="variation-label-badge"></div>
</div>


                        <div class="mt-6 space-y-4">
                            {% for category, options in variation_options.items %}
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">{{ category }}</label>
                                <div class="flex gap-2">
                                    {% for opt in options %}
                                    <button type="button" class="variation-option px-3 py-1 rounded-md border text-sm"
                                        data-cat="{{ category }}" data-val="{{ opt }}" data-value-id="{{ opt.id }}">
                                        {{ opt.value }}
                                    </button>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>

                        

                        <!-- stock + add to cart -->
                        <div class="mt-6 flex items-center gap-4">
                            <div id="stock-text" class="text-sm text-gray-600">In stock</div>
                            <div class="ml-auto flex gap-2">
                                <button id="decrease-qty" class="px-3 py-1 border rounded">-</button>
                                <input id="qty" type="number" value="1" min="1"
                                    class="w-16 text-center border rounded" />
                                <button id="increase-qty" class="px-3 py-1 border rounded">+</button>
                            </div>
                        </div>

                        <div class="mt-6 flex gap-3">
                            <button id="add-to-cart"
                                         data-variation-id="{{ product.primary_item.id }}"
                                            data-product-id="{{ product.id }}"
                                class="add-to-cart bg-[#B01F00] hover:bg-[#801700] text-white px-5 py-3 rounded font-semibold">
                                Add to Cart
                            </button>

                            <button id="buy-now" class="bg-gray-800 text-white px-5 py-3 rounded">Buy Now</button>
                        </div>

                        <!-- short description -->
                        <div class="mt-6 text-sm text-gray-700">
                            {{ product.description|safe }}
                        </div>
                    </div>

                    <!-- Reviews block -->
                    <div class="bg-white rounded-xl shadow p-6 mt-6">
                        <h3 class="font-semibold">Reviews ({{ reviews.count }})</h3>
                        <div class="mt-3 space-y-3">
                            {% for r in reviews %}
                            <div class="border-b pb-3">
                                <div class="flex items-center justify-between">
                                    <div class="text-sm font-semibold">{{ r.user.get_full_name|default:r.user.email }}
                                    </div>
                                    <div class="text-sm text-gray-500">{{ r.created_at|date:"M j, Y" }}</div>
                                </div>
                                <div class="text-sm text-yellow-400 mt-1">
                                    {% with rating=r.rating %}
                                    {% for i in "12345" %}
                                    {% if forloop.counter <= rating %}★{% else %}☆{% endif %} {% endfor %} {% endwith %}
                                        </div>
                                        <div class="mt-2 text-sm text-gray-700">{{ r.comment }}</div>
                                </div>
                                {% empty %}
                                <div class="text-sm text-gray-500">No reviews yet.</div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Related products -->
                        <div class="bg-white rounded-xl shadow p-6 mt-6">
                            <h3 class="font-semibold">Related Products</h3>
                            <div class="grid grid-cols-2 gap-4 mt-4">
                                {% for rp in related_products %}
                                <a href="{% url 'store:product_detail' rp.slug %}" class="block bg-gray-50 rounded p-3">
                                    <img src="{{ rp.primary_image.image.url }}"
                                        class="w-48 h-28 object-contain rounded mb-2">
                                    <div class="text-sm font-semibold">{{ rp.name }}</div>
                                </a>
                                {% endfor %}
                            </div>
                        </div>

                    </div>
                </div>
            </div>


            <script>
                document.addEventListener("DOMContentLoaded", () => {
  const mainImage = document.getElementById("main-image");
  const thumbs = document.querySelectorAll(".thumb");

  thumbs.forEach(btn => {
    btn.addEventListener("click", () => {
      const newSrc = btn.getAttribute("data-src");
      if (newSrc) {
        mainImage.src = newSrc;

        // remove active border
        thumbs.forEach(b => b.classList.remove("ring-2", "ring-red-600"));
        // add highlight to selected thumb
        btn.classList.add("ring-2", "ring-red-600");
      }
    });
  });

  // Init Glide for thumbnails
  new Glide("#thumbs-carousel", {
    type: "carousel",
    perView: 5,
    focusAt: "center",
    gap: 12,
    breakpoints: {
      1024: { perView: 4 },
      768: { perView: 3 },
      480: { perView: 2 },
    }
  }).mount();
});

            </script>


<script>
    document.addEventListener("DOMContentLoaded", () => {
  const mainImage = document.getElementById("main-image");
  const thumbs = document.querySelectorAll(".thumb");
  const modal = document.getElementById("imageModal");
  const modalImage = document.getElementById("modalImage");
  const modalClose = document.getElementById("modalClose");

  // thumbnail click = swap main image
  thumbs.forEach(btn => {
    btn.addEventListener("click", () => {
      const newSrc = btn.getAttribute("data-src");
      mainImage.src = newSrc;
    });
  });

  // open modal on main image click
  mainImage.addEventListener("click", () => {
    modalImage.src = mainImage.src;
    modal.classList.remove("hidden");
    modal.classList.add("flex");
  });

  // close modal
  modalClose.addEventListener("click", () => {
    modal.classList.add("hidden");
    modal.classList.remove("flex");
  });

  // close modal if user clicks outside image
  modal.addEventListener("click", (e) => {
    if (e.target === modal) {
      modal.classList.add("hidden");
      modal.classList.remove("flex");
    }
  });
});
</script>

{% endblock content %}