{% extends "partials/vendor/vendor_navigation.html" %}

{% block vendor_content %}

<link rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
      integrity="sha512-3hbl8+9l2nR9Wf1YVb3q6jg3Jc5JbKcM35e8qgXh+R9s1R3Qe1GQ2T1M2kH3n8vF7C1vY6P9Q8H8nYQG8Zt9xg=="
      crossorigin="anonymous" referrerpolicy="no-referrer" />

<div id="settings-app" class="space-y-6"
     data-user-update-url="{% url 'vendor:user_update_ajax' %}"
     data-vendor-update-url="{% url 'vendor:vendor_update_ajax' %}">

  <!-- Header -->
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-2xl font-bold tracking-tight">Settings</h1>
      <p class="text-sm text-gray-500">Update your account and store details.</p>
    </div>
    <a href="{{ request.get_full_path }}"
       class="inline-flex items-center gap-2 rounded-lg border border-gray-200 px-3 py-2 text-sm font-medium hover:bg-gray-50">
      <i class="fa-solid fa-rotate-left text-gray-700"></i>
      Refresh
    </a>
  </div>

  <!-- Tabs -->
  <div class="rounded-2xl border border-gray-200 bg-white">
    <div class="border-b border-gray-100 px-4 pt-4">
      <nav class="flex gap-1">
        <button type="button" data-tab="user"
                class="tab-btn px-3 py-2 text-sm font-medium rounded-t-lg border-b-2 border-gray-900">
          <i class="fa-solid fa-user-gear mr-2"></i> User Profile
        </button>
        <button type="button" data-tab="store"
                class="tab-btn px-3 py-2 text-sm font-medium rounded-t-lg text-gray-600 hover:text-gray-900 border-b-2 border-transparent">
          <i class="fa-solid fa-shop mr-2"></i> Store Profile
        </button>
      </nav>
    </div>

    <!-- Panels -->
    <div class="p-5">
      <!-- User Profile -->
      <section id="tab-user" class="tab-panel">
        <form id="formUser" class="space-y-4">
          {% csrf_token %}
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="text-sm font-medium">First name</label>
              <input name="first_name" value="{{ user_form.instance.first_name }}"
                     class="mt-1 w-full rounded-xl border border-gray-300 px-3 py-2" maxlength="150">
            </div>
            <div>
              <label class="text-sm font-medium">Last name</label>
              <input name="last_name" value="{{ user_form.instance.last_name }}"
                     class="mt-1 w-full rounded-xl border border-gray-300 px-3 py-2" maxlength="150">
            </div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="md:col-span-1">
              <label class="text-sm font-medium">Email</label>
              <input name="email" type="email" value="{{ user_form.instance.email }}"
                     class="mt-1 w-full rounded-xl border border-gray-300 px-3 py-2">
            </div>
            <div class="md:col-span-1 flex items-end">
              <a href="" class="text-sm text-indigo-600 hover:underline">Change password</a>
            </div>
          </div>

          <div id="userErrors" class="hidden rounded-xl border border-rose-200 bg-rose-50 p-3 text-sm text-rose-700"></div>

          <div class="flex items-center justify-end">
            <button type="submit"
                    class="inline-flex items-center gap-2 rounded-lg bg-gray-900 text-white px-4 py-2 text-sm font-semibold hover:bg-black">
              <i class="fa-solid fa-floppy-disk"></i>
              Save user profile
            </button>
          </div>
        </form>
      </section>

      <!-- Store (Vendor) Profile -->
      <section id="tab-store" class="tab-panel hidden">
        <form id="formVendor" class="space-y-4" enctype="multipart/form-data">
          {% csrf_token %}

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="text-sm font-medium">Business name</label>
              <input name="business_name" value="{{ vendor_form.instance.business_name }}"
                     class="mt-1 w-full rounded-xl border border-gray-300 px-3 py-2" required>
            </div>
            <div>
              <label class="text-sm font-medium">Slug</label>
              <input name="slug" value="{{ vendor_form.instance.slug }}"
                     class="mt-1 w-full rounded-xl border border-gray-300 px-3 py-2" placeholder="auto if blank">
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="text-sm font-medium">Contact email</label>
              <input name="contact_email" type="email" value="{{ vendor_form.instance.contact_email }}"
                     class="mt-1 w-full rounded-xl border border-gray-300 px-3 py-2" required>
            </div>
            <div>
              <label class="text-sm font-medium">Phone</label>
              <input name="business_phone" value="{{ vendor_form.instance.business_phone }}"
                     class="mt-1 w-full rounded-xl border border-gray-300 px-3 py-2">
            </div>
          </div>

          <div>
            <label class="text-sm font-medium">Address</label>
            <input name="business_address" value="{{ vendor_form.instance.business_address }}"
                   class="mt-1 w-full rounded-xl border border-gray-300 px-3 py-2">
          </div>

          <div>
            <label class="text-sm font-medium">Description</label>
            <textarea name="business_description" rows="3"
                      class="mt-1 w-full rounded-xl border border-gray-300 px-3 py-2">{{ vendor_form.instance.business_description }}</textarea>
          </div>

          <!-- Logo / Banner -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="text-sm font-medium">Logo</label>
              <div class="mt-1 flex items-center gap-3">
                <div class="h-16 w-16 rounded-lg bg-gray-100 overflow-hidden grid place-items-center">
                  {% if vendor_form.instance.logo %}
                    <img id="previewLogo" src="{{ vendor_form.instance.logo.url }}" class="h-full w-full object-cover" alt="logo">
                  {% else %}
                    <i class="fa-solid fa-image text-gray-500"></i>
                  {% endif %}
                </div>
                <div class="flex-1">
                  <input id="inputLogo" name="logo" type="file" accept="image/*"
                         class="block w-full text-sm text-gray-600 file:mr-3 file:rounded-lg file:border-0 file:bg-gray-900 file:px-3 file:py-2 file:text-white hover:file:bg-black">
                  <label class="mt-2 inline-flex items-center gap-2 text-xs">
                    <input type="checkbox" name="logo_clear">
                    Remove logo
                  </label>
                </div>
              </div>
            </div>
            <div>
              <label class="text-sm font-medium">Banner</label>
              <div class="mt-1 flex items-center gap-3">
                <div class="h-16 w-28 rounded-lg bg-gray-100 overflow-hidden grid place-items-center">
                  {% if vendor_form.instance.banner %}
                    <img id="previewBanner" src="{{ vendor_form.instance.banner.url }}" class="h-full w-full object-cover" alt="banner">
                  {% else %}
                    <i class="fa-solid fa-image text-gray-500"></i>
                  {% endif %}
                </div>
                <div class="flex-1">
                  <input id="inputBanner" name="banner" type="file" accept="image/*"
                         class="block w-full text-sm text-gray-600 file:mr-3 file:rounded-lg file:border-0 file:bg-gray-900 file:px-3 file:py-2 file:text-white hover:file:bg-black">
                  <label class="mt-2 inline-flex items-center gap-2 text-xs">
                    <input type="checkbox" name="banner_clear">
                    Remove banner
                  </label>
                </div>
              </div>
            </div>
          </div>

          <!-- Web / Social -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="text-sm font-medium">Website</label>
              <input name="website_url" value="{{ vendor_form.instance.website_url|default_if_none:'' }}"
                     class="mt-1 w-full rounded-xl border border-gray-300 px-3 py-2">
            </div>
            <div>
              <label class="text-sm font-medium">Opening hours</label>
              <input name="opening_hours" value="{{ vendor_form.instance.opening_hours|default_if_none:'' }}"
                     class="mt-1 w-full rounded-xl border border-gray-300 px-3 py-2">
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="text-sm font-medium">Instagram</label>
              <input name="socials_instagram" value="{{ vendor_form.initial.socials_instagram|default_if_none:'' }}"
                     class="mt-1 w-full rounded-xl border border-gray-300 px-3 py-2" placeholder="@yourhandle or URL">
            </div>
            <div>
              <label class="text-sm font-medium">Twitter/X</label>
              <input name="socials_twitter" value="{{ vendor_form.initial.socials_twitter|default_if_none:'' }}"
                     class="mt-1 w-full rounded-xl border border-gray-300 px-3 py-2" placeholder="@yourhandle or URL">
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="text-sm font-medium">Facebook</label>
              <input name="socials_facebook" value="{{ vendor_form.initial.socials_facebook|default_if_none:'' }}"
                     class="mt-1 w-full rounded-xl border border-gray-300 px-3 py-2" placeholder="Page URL or handle">
            </div>
            <div>
              <label class="text-sm font-medium">TikTok</label>
              <input name="socials_tiktok" value="{{ vendor_form.initial.socials_tiktok|default_if_none:'' }}"
                     class="mt-1 w-full rounded-xl border border-gray-300 px-3 py-2" placeholder="@yourhandle">
            </div>
          </div>

          <!-- Commerce -->
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
              <label class="text-sm font-medium">Currency</label>
              <input name="currency" value="{{ vendor_form.instance.currency }}"
                     class="mt-1 w-full rounded-xl border border-gray-300 px-3 py-2">
            </div>
            <div>
              <label class="text-sm font-medium">Country</label>
              <input name="country" value="{{ vendor_form.instance.country }}"
                     class="mt-1 w-full rounded-xl border border-gray-300 px-3 py-2">
            </div>
            <div>
              <label class="text-sm font-medium">Tax ID</label>
              <input name="tax_id" value="{{ vendor_form.instance.tax_id|default_if_none:'' }}"
                     class="mt-1 w-full rounded-xl border border-gray-300 px-3 py-2">
            </div>
            <div>
              <label class="text-sm font-medium">Min order (â‚¹)</label>
              <input name="min_order_amount" type="number" step="0.01" min="0"
                     value="{{ vendor_form.instance.min_order_amount }}"
                     class="mt-1 w-full rounded-xl border border-gray-300 px-3 py-2">
            </div>
          </div>

          <div class="flex items-center gap-2">
            <label class="inline-flex items-center gap-2 text-sm">
              <input name="is_open" type="checkbox" {% if vendor_form.instance.is_open %}checked{% endif %}>
              Store is open
            </label>
          </div>

          <!-- Payout -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <label class="text-sm font-medium">Bank name</label>
              <input name="bank_name" value="{{ vendor_form.instance.bank_name|default_if_none:'' }}"
                     class="mt-1 w-full rounded-xl border border-gray-300 px-3 py-2">
            </div>
            <div>
              <label class="text-sm font-medium">Account name</label>
              <input name="account_name" value="{{ vendor_form.instance.account_name|default_if_none:'' }}"
                     class="mt-1 w-full rounded-xl border border-gray-300 px-3 py-2">
            </div>
            <div>
              <label class="text-sm font-medium">Account number</label>
              <input name="account_number" value="{{ vendor_form.instance.account_number|default_if_none:'' }}"
                     class="mt-1 w-full rounded-xl border border-gray-300 px-3 py-2">
            </div>
          </div>

          <div>
            <label class="text-sm font-medium">Shipping policy</label>
            <textarea name="shipping_policy" rows="3"
                      class="mt-1 w-full rounded-xl border border-gray-300 px-3 py-2">{{ vendor_form.instance.shipping_policy }}</textarea>
          </div>
          <div>
            <label class="text-sm font-medium">Return policy</label>
            <textarea name="return_policy" rows="3"
                      class="mt-1 w-full rounded-xl border border-gray-300 px-3 py-2">{{ vendor_form.instance.return_policy }}</textarea>
          </div>

          <div id="vendorErrors" class="hidden rounded-xl border border-rose-200 bg-rose-50 p-3 text-sm text-rose-700"></div>

          <div class="flex items-center justify-end">
            <button type="submit"
                    class="inline-flex items-center gap-2 rounded-lg bg-gray-900 text-white px-4 py-2 text-sm font-semibold hover:bg-black">
              <i class="fa-solid fa-floppy-disk"></i>
              Save store profile
            </button>
          </div>
        </form>
      </section>
    </div>
  </div>

  <!-- toast stack -->
  <div id="toastWrap" class="fixed bottom-6 right-6 space-y-2 z-50"></div>
</div>

<script>
(function(){
  const root = document.getElementById('settings-app');
  const USER_URL   = root.dataset.userUpdateUrl;
  const VENDOR_URL = root.dataset.vendorUpdateUrl;

  const toastWrap = document.getElementById('toastWrap');

  // Tabs
  const tabBtns = document.querySelectorAll('.tab-btn');
  const panels  = document.querySelectorAll('.tab-panel');
  tabBtns.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const tab = btn.dataset.tab;
      tabBtns.forEach(b=>{
        const isActive = b.dataset.tab === tab;
        b.classList.toggle('border-gray-900', isActive);
        b.classList.toggle('text-gray-600', !isActive);
        b.classList.toggle('border-transparent', !isActive);
      });
      panels.forEach(p=> p.classList.toggle('hidden', p.id !== `tab-${tab}`));
    });
  });

  // Image preview
  const inputLogo = document.getElementById('inputLogo');
  const previewLogo = document.getElementById('previewLogo');
  if (inputLogo) {
    inputLogo.addEventListener('change', ()=>{
      const f = inputLogo.files && inputLogo.files[0];
      if (f && previewLogo) previewLogo.src = URL.createObjectURL(f);
    });
  }
  const inputBanner = document.getElementById('inputBanner');
  const previewBanner = document.getElementById('previewBanner');
  if (inputBanner) {
    inputBanner.addEventListener('change', ()=>{
      const f = inputBanner.files && inputBanner.files[0];
      if (f && previewBanner) previewBanner.src = URL.createObjectURL(f);
    });
  }

  // User form
  const formUser = document.getElementById('formUser');
  const userErrors = document.getElementById('userErrors');
  formUser.addEventListener('submit', async (e)=>{
    e.preventDefault();
    userErrors.classList.add('hidden'); userErrors.textContent = '';
    const payload = formToJSON(formUser);
    const res = await postJSON(USER_URL, payload);
    if (res && res.ok) {
      toast('Saved user profile.');
    } else {
      showErrors(userErrors, res);
    }
  });

  // Vendor form (multipart for files)
  const formVendor = document.getElementById('formVendor');
  const vendorErrors = document.getElementById('vendorErrors');
  formVendor.addEventListener('submit', async (e)=>{
    e.preventDefault();
    vendorErrors.classList.add('hidden'); vendorErrors.textContent = '';
    const fd = new FormData(formVendor);
    // checkbox normalization
    fd.set('is_open', formVendor.elements['is_open'].checked ? 'on' : '');
    const res = await postForm(VENDOR_URL, fd);
    if (res && res.ok) {
      toast('Saved store profile.');
      // refresh preview URLs if returned
      if (res.vendor) {
        if (res.vendor.logo_url && document.getElementById('previewLogo')) {
          document.getElementById('previewLogo').src = res.vendor.logo_url;
        }
        if (res.vendor.banner_url && document.getElementById('previewBanner')) {
          document.getElementById('previewBanner').src = res.vendor.banner_url;
        }
      }
    } else {
      showErrors(vendorErrors, res);
    }
  });

  // helpers
  function getCookie(name){
    const v = `; ${document.cookie}`.split(`; ${name}=`); return v.length === 2 ? v.pop().split(';').shift() : null;
  }
  async function postJSON(url, data){
    const r = await fetch(url, {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCookie('csrftoken'),
        'X-Requested-With': 'XMLHttpRequest',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(data || {})
    });
    try { return await r.json(); } catch { return null; }
  }
  async function postForm(url, formData){
    const r = await fetch(url, {
      method: 'POST',
      headers: { 'X-CSRFToken': getCookie('csrftoken'), 'X-Requested-With': 'XMLHttpRequest' },
      body: formData
    });
    try { return await r.json(); } catch { return null; }
  }
  function formToJSON(form){
    const d = new FormData(form), o = {};
    for (const [k,v] of d.entries()) o[k] = v;
    return o;
  }
  function showErrors(container, res){
    const errs = (res && res.errors) || {};
    const flat = Object.entries(errs).map(([k,v]) => `${k}: ${Array.isArray(v)?v.join(', '):v}`).join('\n') || (res && res.message) || 'Validation error.';
    container.textContent = flat;
    container.classList.remove('hidden');
  }
  function toast(msg){
    const id = `t_${Date.now()}`;
    const el = document.createElement('div');
    el.id = id;
    el.className = "rounded-xl bg-gray-900 text-white px-4 py-2 text-sm shadow-lg";
    el.textContent = msg;
    toastWrap.appendChild(el);
    setTimeout(()=>{ el.remove(); }, 3000);
  }
})();
</script>

{% endblock %}
