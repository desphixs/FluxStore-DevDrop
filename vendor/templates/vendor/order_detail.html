{% extends "partials/vendor/vendor_navigation.html" %}

{% block vendor_content %}
<div class="space-y-6">

  <!-- Header -->
  <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
    <div>
      <div class="flex items-center gap-2">
        <h1 class="text-2xl font-bold tracking-tight">Order #{{ order.order_id }}</h1>
        {% if is_paid %}
          <span class="inline-flex items-center rounded-full bg-emerald-50 px-2.5 py-1 text-xs font-medium text-emerald-700">Paid</span>
        {% else %}
          <span class="inline-flex items-center rounded-full bg-amber-50 px-2.5 py-1 text-xs font-medium text-amber-700">Unpaid</span>
        {% endif %}
      </div>
      <p class="text-sm text-gray-500">Placed on {{ order.created_at|date:"M j, Y • H:i" }}</p>
    </div>

    <div class="flex items-center gap-2">
      <a href="{% url 'vendor:orders' %}" class="inline-flex items-center gap-2 rounded-lg border border-gray-200 px-3 py-2 text-sm font-medium hover:bg-gray-50">
        <!-- lucide:arrow-left -->
        <svg class="h-4 w-4 text-gray-700" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"><path d="m12 19-7-7 7-7M19 12H5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        Back to orders
      </a>
      <button type="button" onclick="window.print()" class="inline-flex items-center gap-2 rounded-lg px-3 py-2 text-sm font-semibold bg-gray-900 text-white hover:bg-black">
        <!-- lucide:printer -->
        <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"><path d="M6 9V3h12v6" stroke="currentColor" stroke-width="2"/><path d="M6 18h12v3H6zM6 14h12v4H6z" stroke="currentColor" stroke-width="2"/></svg>
        Print
      </button>
    </div>
  </div>

  <!-- Top summary -->
  <section class="grid grid-cols-1 lg:grid-cols-3 gap-4">
    <!-- Vendor totals -->
    <div class="rounded-2xl border border-gray-200 bg-white p-5">
      <div class="flex items-center justify-between">
        <p class="text-sm text-gray-500">Your totals</p>
        <!-- lucide:banknote -->
        <svg class="h-5 w-5 text-gray-700" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"><rect x="2" y="6" width="20" height="12" rx="2" stroke="currentColor" stroke-width="2"/><circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2"/></svg>
      </div>
      <dl class="mt-3 grid grid-cols-3 gap-3 text-sm">
        <div class="rounded-xl border border-gray-100 p-3">
          <dt class="text-gray-500">Items</dt>
          <dd class="mt-1 text-lg font-semibold">{{ totals.items_count|default:0 }}</dd>
        </div>
        <div class="rounded-xl border border-gray-100 p-3">
          <dt class="text-gray-500">Gross</dt>
          <dd class="mt-1 text-lg font-semibold">{{site_config.currency_abbr}}{{ totals.gross|floatformat:2 }}</dd>
        </div>
        <div class="rounded-xl border border-gray-100 p-3">
          <dt class="text-gray-500">Net</dt>
          <dd class="mt-1 text-lg font-semibold">{{site_config.currency_abbr}}{{ totals.net|floatformat:2 }}</dd>
        </div>
      </dl>
      <p class="mt-2 text-xs text-gray-500">Discounts applied: {{site_config.currency_abbr}}{{ totals.discount|floatformat:2 }}</p>
    </div>

    <!-- Payment & fulfillment -->
    <div class="rounded-2xl border border-gray-200 bg-white p-5">
      <div class="flex items-center justify-between">
        <p class="text-sm text-gray-500">Status</p>
        <!-- lucide:badge-check -->
        <svg class="h-5 w-5 text-gray-700" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"><path d="m7 11 2 2 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 2l2 2 3-.5-.5 3L19 9l-2.4 1.4.5 3-3-.5L12 17l-2-2-3 .5.5-3L5 9l2.4-1.4-.5-3 3 .5L12 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </div>
      <div class="mt-3 space-y-2 text-sm">
        <div class="flex items-center justify-between">
          <span class="text-gray-500">Payment</span>
          {% if is_paid %}
            <span class="inline-flex items-center rounded-full bg-emerald-50 px-2.5 py-1 text-xs font-medium text-emerald-700">Paid</span>
          {% else %}
            <span class="inline-flex items-center rounded-full bg-amber-50 px-2.5 py-1 text-xs font-medium text-amber-700">Unpaid</span>
          {% endif %}
        </div>
        <div class="flex items-center justify-between">
          <span class="text-gray-500">Fulfillment</span>
          {% if order.status == "DELIVERED" %}
            <span class="inline-flex items-center rounded-full bg-emerald-50 px-2.5 py-1 text-xs font-medium text-emerald-700">Delivered</span>
          {% elif order.status == "PROCESSING" %}
            <span class="inline-flex items-center rounded-full bg-blue-50 px-2.5 py-1 text-xs font-medium text-blue-700">Processing</span>
          {% elif order.status == "SHIPPED" %}
            <span class="inline-flex items-center rounded-full bg-indigo-50 px-2.5 py-1 text-xs font-medium text-indigo-700">Shipped</span>
          {% elif order.status == "PENDING" %}
            <span class="inline-flex items-center rounded-full bg-gray-100 px-2.5 py-1 text-xs font-medium text-gray-700">Pending</span>
          {% elif order.status == "CANCELED" %}
            <span class="inline-flex items-center rounded-full bg-rose-50 px-2.5 py-1 text-xs font-medium text-rose-700">Canceled</span>
          {% elif order.status == "REFUNDED" %}
            <span class="inline-flex items-center rounded-full bg-zinc-100 px-2.5 py-1 text-xs font-medium text-zinc-700">Refunded</span>
          {% else %}
            <span class="inline-flex items-center rounded-full bg-gray-100 px-2.5 py-1 text-xs font-medium text-gray-700">{{ order.status|title }}</span>
          {% endif %}
        </div>
        <div class="flex items-center justify-between">
          <span class="text-gray-500">Courier</span>
          <span class="text-gray-800">{% if order.courier_name %}{{ order.courier_name }}{% else %}-{% endif %}</span>
        </div>
        {% if order.etd_text %}
        <div class="flex items-center justify-between">
          <span class="text-gray-500">ETA</span>
          <span class="text-gray-800">{{ order.etd_text }}</span>
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Payment refs -->
    <div class="rounded-2xl border border-gray-200 bg-white p-5">
      <div class="flex items-center justify-between">
        <p class="text-sm text-gray-500">Payment details</p>
        <!-- lucide:wallet -->
        <svg class="h-5 w-5 text-gray-700" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"><rect x="2" y="6" width="20" height="14" rx="2" stroke="currentColor" stroke-width="2"/><path d="M16 10h4v6h-4z" stroke="currentColor" stroke-width="2"/></svg>
      </div>
      <dl class="mt-3 grid grid-cols-2 gap-3 text-sm">
        <div class="rounded-xl border border-gray-100 p-3">
          <dt class="text-gray-500">Provider</dt>
          <dd class="mt-1 text-gray-800">{{ order.payment_provider|default:"—" }}</dd>
        </div>
        <div class="rounded-xl border border-gray-100 p-3">
          <dt class="text-gray-500">Easebuzz Txn</dt>
          <dd class="mt-1 text-gray-800">{{ order.easebuzz_txnid|default:"—" }}</dd>
        </div>
        <div class="rounded-xl border border-gray-100 p-3">
          <dt class="text-gray-500">Easebuzz PID</dt>
          <dd class="mt-1 text-gray-800">{{ order.easebuzz_payment_id|default:"—" }}</dd>
        </div>
        <div class="rounded-xl border border-gray-100 p-3">
          <dt class="text-gray-500">Currency</dt>
          <dd class="mt-1 text-gray-800">{{ order.currency|default:"INR" }}</dd>
        </div>
      </dl>
    </div>
  </section>

  <!-- Main grid: items + customer/shipping -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

    <!-- Items (vendor-only) -->
    <section class="lg:col-span-2 rounded-2xl border border-gray-200 bg-white overflow-hidden">
      <div class="px-5 py-4 border-b border-gray-100 flex items-center justify-between">
        <h2 class="text-sm font-semibold tracking-wide">Items (your listings)</h2>
        <div class="text-xs text-gray-500">Net: {{site_config.currency_abbr}}{{ totals.net|floatformat:2 }}</div>
      </div>

      {% if items %}
      <div class="divide-y divide-gray-100">
        {% for it in items %}
          {% with pv=it.product_variation p=it.product_variation.product %}
          <div class="p-4 flex items-center gap-3">
            <div class="h-14 w-14 rounded-xl bg-gray-100 overflow-hidden flex items-center justify-center shrink-0">
              {% if p and p.primary_image and p.primary_image.image %}
                <img src="{{ p.primary_image.image.url }}" alt="{{ p.name }}" class="h-full w-full object-cover">
              {% else %}
                <!-- lucide:box -->
                <svg class="h-6 w-6 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"><path d="m21 16-9 5-9-5M12 3v18M3.3 7.3 12 12l8.7-4.7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
              {% endif %}
            </div>

            <div class="min-w-0 flex-1">
              <div class="flex items-start justify-between gap-2">
                <div class="min-w-0">
                  <div class="font-medium truncate">{{ p.name }}</div>
                  <div class="text-xs text-gray-500 truncate">
                    {% for vv in it.variation_values.all %}
                      {{ vv.category.name }}: {{ vv.value }}{% if not forloop.last %}, {% endif %}
                    {% empty %}—{% endfor %}
                  </div>
                  <div class="text-xs text-gray-400 mt-0.5">SKU: {{ pv.sku }}</div>
                </div>
                <div class="text-right">
                  <div class="text-sm text-gray-700">{{site_config.currency_abbr}}{{ it.price|floatformat:2 }}</div>
                  <div class="text-xs text-gray-500">Qty: {{ it.quantity }}</div>
                </div>
              </div>

              <div class="mt-2 grid grid-cols-3 gap-3 text-sm">
                <div class="rounded-xl border border-gray-100 p-2">
                  <div class="text-xs text-gray-500">Subtotal</div>
                  <div class="font-semibold">{{site_config.currency_abbr}}{{ it.line_subtotal|floatformat:2 }}</div>
                </div>
                <div class="rounded-xl border border-gray-100 p-2">
                  <div class="text-xs text-gray-500">Discount</div>
                  <div class="font-semibold">{{site_config.currency_abbr}}{{ it.line_discount_total|floatformat:2 }}</div>
                </div>
                <div class="rounded-xl border border-gray-100 p-2">
                  <div class="text-xs text-gray-500">Net</div>
                  <div class="font-semibold">{{site_config.currency_abbr}}{{ it.line_net|floatformat:2 }}</div>
                </div>
              </div>

              <div class="mt-3">
                <button
                  type="button"
                  class="inline-flex items-center gap-1.5 rounded-lg border border-gray-200 px-3 py-1.5 text-xs font-medium hover:bg-gray-50"
                  data-modal-open
                  data-name="{{ p.name|escape }}"
                  data-sku="{{ pv.sku|escape }}"
                  data-variants="{% for vv in it.variation_values.all %}{{ vv.category.name }}: {{ vv.value }}{% if not forloop.last %}, {% endif %}{% endfor %}"
                  data-price="{{ it.price|floatformat:2 }}"
                  data-qty="{{ it.quantity }}"
                  data-subtotal="{{ it.line_subtotal|floatformat:2 }}"
                  data-discount="{{ it.line_discount_total|floatformat:2 }}"
                  data-net="{{ it.line_net|floatformat:2 }}"
                  data-weight="{{ pv.weight }}"
                  data-dims="{{ pv.length }} × {{ pv.width }} × {{ pv.height }} cm"
                  data-img="{% if p and p.primary_image and p.primary_image.image %}{{ p.primary_image.image.url }}{% endif %}"
                >
                  <!-- lucide:eye -->
                  <svg class="h-3.5 w-3.5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"><path d="M2 12s3.5-7 10-7 10 7 10 7-3.5 7-10 7-10-7-10-7Z" stroke="currentColor" stroke-width="2"/><circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2"/></svg>
                  View item
                </button>
              </div>
            </div>
          </div>
          {% endwith %}
        {% endfor %}
      </div>

      <div class="px-5 py-4 border-t border-gray-100">
        <div class="flex items-center justify-end gap-6 text-sm">
          <div><span class="text-gray-500">Gross:</span> <span class="font-semibold">{{site_config.currency_abbr}}{{ totals.gross|floatformat:2 }}</span></div>
          <div><span class="text-gray-500">Discount:</span> <span class="font-semibold">{{site_config.currency_abbr}}{{ totals.discount|floatformat:2 }}</span></div>
          <div><span class="text-gray-500">Net:</span> <span class="font-semibold">{{site_config.currency_abbr}}{{ totals.net|floatformat:2 }}</span></div>
        </div>
      </div>

      {% else %}
        <div class="p-6 text-center text-sm text-gray-500">No items for you in this order.</div>
      {% endif %}
    </section>

    <!-- Right column: customer + shipping + coupons -->
    <div class="space-y-4">
      <section class="rounded-2xl border border-gray-200 bg-white p-5">
        <div class="flex items-center justify-between">
          <h3 class="text-sm font-semibold tracking-wide">Customer</h3>
          <!-- lucide:user -->
          <svg class="h-4 w-4 text-gray-700" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="7" r="4" stroke="currentColor" stroke-width="2"/><path d="M6 21v-2a6 6 0 0 1 12 0v2" stroke="currentColor" stroke-width="2"/></svg>
        </div>
        <div class="mt-3 text-sm">
          {% if order.buyer %}
            <div class="font-medium">{{ order.buyer.get_full_name|default:order.buyer.email }}</div>
            <div class="text-gray-600">{{ order.buyer.email }}</div>
          {% else %}
            <div class="text-gray-600">—</div>
          {% endif %}
        </div>
      </section>

      <section class="rounded-2xl border border-gray-200 bg-white p-5">
        <div class="flex items-center justify-between">
          <h3 class="text-sm font-semibold tracking-wide">Shipping</h3>
          <!-- lucide:map-pin -->
          <svg class="h-4 w-4 text-gray-700" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"><path d="M12 21s-6-5.4-6-10a6 6 0 1 1 12 0c0 4.6-6 10-6 10Z" stroke="currentColor" stroke-width="2"/><circle cx="12" cy="11" r="2" stroke="currentColor" stroke-width="2"/></svg>
        </div>
        <div class="mt-3 text-sm text-gray-700">
          {% if order.shipping_address_snapshot %}
            <div>{{ order.shipping_address_snapshot.full_name }}</div>
            <div class="text-gray-600">{{ order.shipping_address_snapshot.phone }}</div>
            <div class="mt-1">{{ order.shipping_address_snapshot.street_address }}</div>
            <div>{{ order.shipping_address_snapshot.city }}, {{ order.shipping_address_snapshot.state }} {{ order.shipping_address_snapshot.postal_code }}</div>
            <div class="text-gray-600">{{ order.shipping_address_snapshot.country }}</div>
          {% elif order.address %}
            <div>{{ order.address.full_name }}</div>
            <div class="text-gray-600">{{ order.address.phone }}</div>
            <div class="mt-1">{{ order.address.street_address }}</div>
            <div>{{ order.address.city }}, {{ order.address.state }} {{ order.address.postal_code }}</div>
            <div class="text-gray-600">{{ order.address.country }}</div>
          {% else %}
            <div class="text-gray-500">No shipping address available.</div>
          {% endif %}
        </div>
        <div class="mt-3 text-xs text-gray-500">
          Courier: {% if order.courier_name %}{{ order.courier_name }}{% else %}-{% endif %}
          {% if order.courier_service_name %} • {{ order.courier_service_name }}{% endif %}
        </div>
      </section>

      <section class="rounded-2xl border border-gray-200 bg-white p-5">
        <div class="flex items-center justify-between">
          <h3 class="text-sm font-semibold tracking-wide">Coupons (your items)</h3>
          <!-- lucide:ticket -->
          <svg class="h-4 w-4 text-gray-700" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"><path d="M3 9a2 2 0 1 0 0 6v4h18v-4a2 2 0 1 0 0-6V5H3v4Z" stroke="currentColor" stroke-width="2"/></svg>
        </div>
        {% if coupons %}
          <ul class="mt-3 space-y-2 text-sm">
            {% for c in coupons %}
              <li class="flex items-center justify-between rounded-xl border border-gray-100 p-3">
                <div>
                  <div class="font-medium">{{ c.coupon__code }}</div>
                  <div class="text-xs text-gray-500">{{ c.coupon__discount_type|title }} • {{site_config.currency_abbr}}{{ c.discount_amount|floatformat:2 }}</div>
                </div>
                <div class="text-xs text-gray-500">{{ c.applied_at }}</div>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="mt-3 text-sm text-gray-500">No coupons applied to your items.</div>
        {% endif %}
      </section>
    </div>

  </div>
</div>

<!-- ITEM MODAL -->
<div id="itemModal" class="fixed inset-0 z-50 hidden">
  <div class="absolute inset-0 bg-black/50" data-modal-close></div>
  <div class="relative mx-auto mt-20 w-[90%] max-w-2xl rounded-2xl bg-white shadow-xl">
    <div class="flex items-center justify-between border-b border-gray-200 px-5 py-3">
      <h3 class="text-sm font-semibold">Item details</h3>
      <button class="rounded-lg p-2 hover:bg-gray-100" data-modal-close>
        <!-- lucide:x -->
        <svg class="h-5 w-5 text-gray-700" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"><path d="M18 6 6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
      </button>
    </div>

    <div class="p-5 grid grid-cols-1 sm:grid-cols-[5rem_1fr] gap-4">
      <div class="h-20 w-20 rounded-xl bg-gray-100 overflow-hidden flex items-center justify-center">
        <img id="mImg" alt="" class="h-full w-full object-cover hidden">
        <!-- lucide:image -->
        <svg id="mImgFallback" class="h-6 w-6 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"><rect x="3" y="3" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2"/><path d="m9 14 2-2 3 3 2-2 3 3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </div>

      <div>
        <div class="text-base font-semibold" id="mName">—</div>
        <div class="text-xs text-gray-500 mt-0.5" id="mVariants">—</div>
        <div class="text-xs text-gray-400 mt-0.5">SKU: <span id="mSku">—</span></div>

        <div class="mt-3 grid grid-cols-3 gap-3 text-sm">
          <div class="rounded-xl border border-gray-100 p-3">
            <div class="text-xs text-gray-500">Price</div>
            <div class="font-semibold">{{site_config.currency_abbr}}<span id="mPrice">0.00</span></div>
          </div>
          <div class="rounded-xl border border-gray-100 p-3">
            <div class="text-xs text-gray-500">Qty</div>
            <div class="font-semibold" id="mQty">0</div>
          </div>
          <div class="rounded-xl border border-gray-100 p-3">
            <div class="text-xs text-gray-500">Subtotal</div>
            <div class="font-semibold">{{site_config.currency_abbr}}<span id="mSubtotal">0.00</span></div>
          </div>
          <div class="rounded-xl border border-gray-100 p-3">
            <div class="text-xs text-gray-500">Discount</div>
            <div class="font-semibold">{{site_config.currency_abbr}}<span id="mDiscount">0.00</span></div>
          </div>
          <div class="rounded-xl border border-gray-100 p-3">
            <div class="text-xs text-gray-500">Net</div>
            <div class="font-semibold">{{site_config.currency_abbr}}<span id="mNet">0.00</span></div>
          </div>
          <div class="rounded-xl border border-gray-100 p-3">
            <div class="text-xs text-gray-500">Weight</div>
            <div class="font-semibold"><span id="mWeight">—</span> kg</div>
          </div>
          <div class="rounded-xl border border-gray-100 p-3">
            <div class="text-xs text-gray-500">Dimensions</div>
            <div class="font-semibold"><span id="mDims">—</span></div>
          </div>
        </div>
      </div>
    </div>

    <div class="px-5 py-3 border-t border-gray-200 flex items-center justify-end">
      <button class="rounded-lg px-4 py-2 text-sm border border-gray-200 hover:bg-gray-50" data-modal-close>Close</button>
    </div>
  </div>
</div>

<script>
(function(){
  const modal = document.getElementById('itemModal');
  const img = document.getElementById('mImg');
  const imgFallback = document.getElementById('mImgFallback');

  function openModal(dataBtn){
    document.getElementById('mName').textContent = dataBtn.dataset.name || '—';
    document.getElementById('mSku').textContent = dataBtn.dataset.sku || '—';
    document.getElementById('mVariants').textContent = (dataBtn.dataset.variants || '—');
    document.getElementById('mPrice').textContent = dataBtn.dataset.price || '0.00';
    document.getElementById('mQty').textContent = dataBtn.dataset.qty || '0';
    document.getElementById('mSubtotal').textContent = dataBtn.dataset.subtotal || '0.00';
    document.getElementById('mDiscount').textContent = dataBtn.dataset.discount || '0.00';
    document.getElementById('mNet').textContent = dataBtn.dataset.net || '0.00';
    document.getElementById('mWeight').textContent = dataBtn.dataset.weight || '—';
    document.getElementById('mDims').textContent = dataBtn.dataset.dims || '—';

    const src = dataBtn.dataset.img || '';
    if (src) {
      img.src = src;
      img.classList.remove('hidden');
      imgFallback.classList.add('hidden');
    } else {
      img.src = '';
      img.classList.add('hidden');
      imgFallback.classList.remove('hidden');
    }

    modal.classList.remove('hidden');
    document.body.classList.add('overflow-hidden');
  }

  function closeModal(){
    modal.classList.add('hidden');
    document.body.classList.remove('overflow-hidden');
  }

  document.querySelectorAll('[data-modal-open]').forEach(btn => {
    btn.addEventListener('click', () => openModal(btn));
  });
  modal.querySelectorAll('[data-modal-close]').forEach(el => {
    el.addEventListener('click', closeModal);
  });
  window.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && !modal.classList.contains('hidden')) closeModal();
  });
})();
</script>
{% endblock %}
